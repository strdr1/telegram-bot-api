"""
main.py
–ì–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞
"""

import asyncio
import logging
from aiogram import Bot, Dispatcher
from aiogram.fsm.storage.memory import MemoryStorage
from config import BOT_TOKEN
from handlers.main_handlers import router as main_router
from handlers.callback_handlers import router as callback_router
from handlers.booking_handlers import router as booking_router
import database as db

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    datefmt='%Y-%m-%d %H:%M:%S'
)
logger = logging.getLogger(__name__)

async def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞"""
    bot = Bot(token=BOT_TOKEN)
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º MemoryStorage –¥–ª—è FSM (Finite State Machine)
    storage = MemoryStorage()
    dp = Dispatcher(storage=storage)
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
    db.init_db()
    logger.info("–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞")
    
    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Ä–æ—É—Ç–µ—Ä—ã
    dp.include_router(main_router)
    dp.include_router(callback_router)
    dp.include_router(booking_router)
    
    logger.info("ü§ñ –ë–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...")
    logger.info("üìç –†–µ—Å—Ç–æ—Ä–∞–Ω: –ú–∞—à–∫–æ–≤")
    logger.info("üìÖ –°–∏—Å—Ç–µ–º–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: –í–ö–õ–Æ–ß–ï–ù–ê")
    
    try:
        await dp.start_polling(bot)
    except KeyboardInterrupt:
        logger.info("‚èπÔ∏è –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞: {e}")

if __name__ == "__main__":
    asyncio.run(main())

"""
database.py
–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–æ—Ä–∑–∏–Ω—ã –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
"""

import sqlite3
from datetime import datetime
import json

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
def init_db():
    conn = sqlite3.connect('restaurant.db')
    cursor = conn.cursor()
    
    # –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS users (
        user_id INTEGER PRIMARY KEY,
        username TEXT,
        full_name TEXT,
        phone TEXT,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    )
    ''')
    
    # –¢–∞–±–ª–∏—Ü–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS bookings (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER,
        date TEXT NOT NULL,
        time TEXT NOT NULL,
        phone TEXT NOT NULL,
        guests INTEGER DEFAULT 2,
        status TEXT DEFAULT 'active',
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (user_id) REFERENCES users (user_id)
    )
    ''')
    
    # –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_bookings_user ON bookings(user_id)')
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_bookings_status ON bookings(status)')
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_bookings_date ON bookings(date)')
    
    conn.commit()
    conn.close()

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–∞–∑—É –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ
init_db()

# –•—Ä–∞–Ω–∏–º –∫–æ—Ä–∑–∏–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π {user_id: [items]}
user_carts = {}

# –•—Ä–∞–Ω–∏–º –º–µ–Ω—é
menu_items = {
    "salad_caesar": {"id": "salad_caesar", "name": "–¶–µ–∑–∞—Ä—å —Å –∫—Ä–µ–≤–µ—Ç–∫–∞–º–∏", "price": 680, "category": "salads"},
    "salad_greek": {"id": "salad_greek", "name": "–ì—Ä–µ—á–µ—Å–∫–∏–π", "price": 820, "category": "salads"},
    "soup_tomato": {"id": "soup_tomato", "name": "–¢–æ–º–∞—Ç–Ω—ã–π —Å—É–ø", "price": 650, "category": "soups"},
    "soup_borsch": {"id": "soup_borsch", "name": "–ë–æ—Ä—â", "price": 550, "category": "soups"},
    "steak_ribeye": {"id": "steak_ribeye", "name": "–°—Ç–µ–π–∫ –†–∏–±–∞–π", "price": 1200, "category": "hot"},
    "duck_apple": {"id": "duck_apple", "name": "–£—Ç–∫–∞ —Å —è–±–ª–æ–∫–∞–º–∏", "price": 950, "category": "hot"},
    "tiramisu": {"id": "tiramisu", "name": "–¢–∏—Ä–∞–º–∏—Å—É", "price": 350, "category": "desserts"},
    "cheesecake": {"id": "cheesecake", "name": "–ß–∏–∑–∫–µ–π–∫", "price": 380, "category": "desserts"},
}

# === –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ë–†–û–ù–ò–†–û–í–ê–ù–ò–ô ===

def get_user_active_booking(user_id):
    """–ü–æ–ª—É—á–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—É—é –±—Ä–æ–Ω—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    conn = sqlite3.connect('restaurant.db')
    cursor = conn.cursor()
    
    cursor.execute('''
    SELECT id, date, time, phone, guests, created_at
    FROM bookings 
    WHERE user_id = ? AND status = 'active'
    ORDER BY created_at DESC
    LIMIT 1
    ''', (user_id,))
    
    result = cursor.fetchone()
    conn.close()
    
    if result:
        return {
            'id': result[0],
            'date': result[1],
            'time': result[2],
            'phone': result[3],
            'guests': result[4],
            'created_at': result[5]
        }
    return None

def create_booking(user_id, date, time, phone, guests=2):
    """–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –±—Ä–æ–Ω—å"""
    conn = sqlite3.connect('restaurant.db')
    cursor = conn.cursor()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    cursor.execute('SELECT 1 FROM users WHERE user_id = ?', (user_id,))
    if not cursor.fetchone():
        # –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        cursor.execute('INSERT INTO users (user_id) VALUES (?)', (user_id,))
    
    # –û—Ç–º–µ–Ω—è–µ–º —Å—Ç–∞—Ä—ã–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –±—Ä–æ–Ω–∏
    cursor.execute('''
    UPDATE bookings 
    SET status = 'cancelled' 
    WHERE user_id = ? AND status = 'active'
    ''', (user_id,))
    
    # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –±—Ä–æ–Ω—å
    cursor.execute('''
    INSERT INTO bookings (user_id, date, time, phone, guests)
    VALUES (?, ?, ?, ?, ?)
    ''', (user_id, date, time, phone, guests))
    
    booking_id = cursor.lastrowid
    conn.commit()
    conn.close()
    
    return booking_id

def cancel_booking(booking_id):
    """–û—Ç–º–µ–Ω–∏—Ç—å –±—Ä–æ–Ω—å"""
    conn = sqlite3.connect('restaurant.db')
    cursor = conn.cursor()
    
    cursor.execute('''
    UPDATE bookings 
    SET status = 'cancelled' 
    WHERE id = ?
    ''', (booking_id,))
    
    conn.commit()
    conn.close()
    return True

def delete_booking(booking_id):
    """–£–¥–∞–ª–∏—Ç—å –±—Ä–æ–Ω—å"""
    conn = sqlite3.connect('restaurant.db')
    cursor = conn.cursor()
    
    cursor.execute('DELETE FROM bookings WHERE id = ?', (booking_id,))
    
    conn.commit()
    conn.close()
    return True

# === –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ö–û–†–ó–ò–ù–´ ===

def get_user_cart(user_id):
    """–ü–æ–ª—É—á–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    return user_carts.get(user_id, [])

def add_to_cart(user_id, item_id, quantity=1):
    """–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä –≤ –∫–æ—Ä–∑–∏–Ω—É"""
    if user_id not in user_carts:
        user_carts[user_id] = []
    
    item = menu_items.get(item_id)
    if not item:
        return False
    
    # –ò—â–µ–º —É–∂–µ –µ—Å—Ç—å –ª–∏ —Ç–∞–∫–æ–π —Ç–æ–≤–∞—Ä –≤ –∫–æ—Ä–∑–∏–Ω–µ
    for cart_item in user_carts[user_id]:
        if cart_item["id"] == item_id:
            cart_item["quantity"] += quantity
            return True
    
    # –ï—Å–ª–∏ –Ω–µ—Ç - –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π
    user_carts[user_id].append({
        "id": item_id,
        "name": item["name"],
        "price": item["price"],
        "quantity": quantity
    })
    return True

def remove_from_cart(user_id, item_id):
    """–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã"""
    if user_id not in user_carts:
        return False
    
    user_carts[user_id] = [item for item in user_carts[user_id] if item["id"] != item_id]
    return True

def update_quantity(user_id, item_id, quantity):
    """–û–±–Ω–æ–≤–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞"""
    if user_id not in user_carts:
        return False
    
    for item in user_carts[user_id]:
        if item["id"] == item_id:
            if quantity <= 0:
                return remove_from_cart(user_id, item_id)
            item["quantity"] = quantity
            return True
    return False

def clear_cart(user_id):
    """–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É"""
    if user_id in user_carts:
        user_carts[user_id] = []
    return True

def get_cart_total(user_id):
    """–ü–æ–ª—É—á–∏—Ç—å –æ–±—â—É—é —Å—É–º–º—É –∫–æ—Ä–∑–∏–Ω—ã"""
    cart = get_user_cart(user_id)
    total = sum(item["price"] * item["quantity"] for item in cart)
    return total

def get_cart_item_count(user_id):
    """–ü–æ–ª—É—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∫–æ—Ä–∑–∏–Ω–µ"""
    cart = get_user_cart(user_id)
    return sum(item["quantity"] for item in cart)

def get_delivery_cost(user_id):
    """–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏"""
    from config import DELIVERY_COST, FREE_DELIVERY_MIN
    total = get_cart_total(user_id)
    if total >= FREE_DELIVERY_MIN or total == 0:
        return 0
    return DELIVERY_COST

"""
config.py
–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–æ—Ç–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
"""

# –¢–æ–∫–µ–Ω –±–æ—Ç–∞
BOT_TOKEN = "8259134855:AAHI1X_6K-1AbHAHR34pzK5RQbVWoqv4b6g"

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
RESTAURANT_NAME = "Mashkov.rest"
RESTAURANT_ADDRESS = "–±—É–ª. –ê–∫–∞–¥–µ–º–∏–∫–∞ –õ–∞–Ω–¥–∞—É, 1, –ú–æ—Å–∫–≤–∞"
RESTAURANT_PHONE = "+7 (903) 748-80-80"
RESTAURANT_HOURS = "–ï–∂–µ–¥–Ω–µ–≤–Ω–æ —Å 08:00 –¥–æ 22:00"

# Telegram –∫–∞–Ω–∞–ª
TELEGRAM_CHANNEL = "https://t.me/Mashkov_rest"

# URL –¥–ª—è –æ—Ç–∑—ã–≤–æ–≤
YANDEX_REVIEWS_URL = "https://yandex.ru/maps/org/mashkov/202266309008/reviews/"
YANDEX_ADD_REVIEW_URL = "https://yandex.ru/maps/org/mashkov/202266309008/reviews/add/"

# 3D-—Ç—É—Ä
THREE_D_TOUR_URL = "https://example.com/3d-tour"

# –î–æ—Å—Ç–∞–≤–∫–∞
DELIVERY_COST = 200  # —Ä—É–±–ª–µ–π
FREE_DELIVERY_MIN = 1500  # —Ä—É–±–ª–µ–π
DELIVERY_TIME = "45-60 –º–∏–Ω—É-—Ç"

"""
keyboards/cart.py
–ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã –¥–ª—è –∫–æ—Ä–∑–∏–Ω—ã
"""

from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
import database as db

def get_cart_menu(user_id):
    """–ú–µ–Ω—é –∫–æ—Ä–∑–∏–Ω—ã - –ë–ï–ó –∫–Ω–æ–ø–∫–∏ "–ö –º–µ–Ω—é" """
    cart = db.get_user_cart(user_id)
    
    if not cart:
        # –ï—Å–ª–∏ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞ - –Ω–∏–∫–∞–∫–∏—Ö –∫–Ω–æ–ø–æ–∫
        return InlineKeyboardMarkup(inline_keyboard=[])
    
    # –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–≤–∞—Ä–∞
    keyboard = []
    
    for item in cart:
        row = [
            InlineKeyboardButton(text="‚ûñ", callback_data=f"cart_minus_{item['id']}"),
            InlineKeyboardButton(text=f"{item['name']} √ó{item['quantity']}", callback_data="no_action"),
            InlineKeyboardButton(text="‚ûï", callback_data=f"cart_plus_{item['id']}")
        ]
        keyboard.append(row)
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ—Ä–∑–∏–Ω–æ–π
    keyboard.append([
        InlineKeyboardButton(text="üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É", callback_data="cart_clear"),
    ])
    
    # –ö–Ω–æ–ø–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —Ç–æ–≤–∞—Ä—ã)
    keyboard.append([
        InlineKeyboardButton(text="‚úÖ –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑", callback_data="checkout"),
    ])
    
    return InlineKeyboardMarkup(inline_keyboard=keyboard)

def get_checkout_menu():
    """–ú–µ–Ω—é –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞"""
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [
                InlineKeyboardButton(text="üíµ –ù–∞–ª–∏—á–Ω—ã–º–∏ –∫—É—Ä—å–µ—Ä—É", callback_data="payment_cash"),
            ],
            [
                InlineKeyboardButton(text="üí≥ –ö–∞—Ä—Ç–æ–π –∫—É—Ä—å–µ—Ä—É", callback_data="payment_card"),
            ],
            [
                InlineKeyboardButton(text="üí≥ –û–ø–ª–∞—Ç–∏—Ç—å –æ–Ω–ª–∞–π–Ω", callback_data="payment_now"),
            ],
            [
                InlineKeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –∫–æ—Ä–∑–∏–Ω—É", callback_data="back_to_cart_action"),
            ]
        ]
    )

def get_back_to_cart():
    """–ö–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –∫–æ—Ä–∑–∏–Ω—É (–¥–ª—è –æ–ø–ª–∞—Ç—ã –æ–Ω–ª–∞–π–Ω)"""
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [
                InlineKeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –∫–æ—Ä–∑–∏–Ω—É", callback_data="back_to_cart_action"),
            ]
        ]
    )

"""
handlers/callback_handlers.py
–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–ª–±—ç–∫–æ–≤ (–Ω–∞–∂–∞—Ç–∏–π –Ω–∞ –∫–Ω–æ–ø–∫–∏) —Å –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
"""

from aiogram import Router, F
from aiogram.types import CallbackQuery, InlineKeyboardMarkup, InlineKeyboardButton
import keyboards as kb
import database as db
from config import RESTAURANT_NAME, RESTAURANT_ADDRESS, RESTAURANT_PHONE, RESTAURANT_HOURS
from config import DELIVERY_COST, FREE_DELIVERY_MIN, DELIVERY_TIME, TELEGRAM_CHANNEL

router = Router()

# –•—Ä–∞–Ω–∏–º ID —Å–æ–æ–±—â–µ–Ω–∏–π –∫–æ—Ä–∑–∏–Ω—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id: message_id}
cart_messages = {}

# === –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ===
def get_guest_word(count):
    """–ü–æ–ª—É—á–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–ª–æ–≤–æ –¥–ª—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≥–æ—Å—Ç–µ–π"""
    if count == 1:
        return "–≥–æ—Å—Ç—å"
    elif 2 <= count <= 4:
        return "–≥–æ—Å—Ç—è"
    else:
        return "–≥–æ—Å—Ç–µ–π"

async def show_cart_message(bot, user_id):
    """–ü–æ–∫–∞–∑–∞—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–æ—Ä–∑–∏–Ω–æ–π"""
    cart = db.get_user_cart(user_id)
    cart_total = db.get_cart_total(user_id)
    delivery_cost = db.get_delivery_cost(user_id)
    total_with_delivery = cart_total + delivery_cost
    
    if cart:
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –∫–æ—Ä–∑–∏–Ω—ã
        cart_text = "<b>üõí –í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞</b>\n\n"
        
        for item in cart:
            item_total = item["price"] * item["quantity"]
            cart_text += f"‚Ä¢ {item['name']}\n"
            cart_text += f"  {item['quantity']} x {item['price']}‚ÇΩ = {item_total}‚ÇΩ\n"
        
        cart_text += f"\n<b>–°—É–º–º–∞ –∑–∞–∫–∞–∑–∞:</b> {cart_total}‚ÇΩ"
        
        if delivery_cost > 0:
            cart_text += f"\n<b>–î–æ—Å—Ç–∞–≤–∫–∞:</b> {delivery_cost}‚ÇΩ"
            cart_text += f"\n<b>–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</b> {total_with_delivery}‚ÇΩ"
            
            if cart_total < FREE_DELIVERY_MIN:
                cart_text += f"\n\nüéÅ <i>–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ –æ—Ç {FREE_DELIVERY_MIN}‚ÇΩ</i>"
                cart_text += f"\n<i>–î–æ–±–∞–≤—å—Ç–µ –µ—â–µ {FREE_DELIVERY_MIN - cart_total}‚ÇΩ</i>"
        else:
            cart_text += f"\n<b>–î–æ—Å—Ç–∞–≤–∫–∞:</b> –±–µ—Å–ø–ª–∞—Ç–Ω–æ üéâ"
            cart_text += f"\n<b>–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</b> {total_with_delivery}‚ÇΩ"
    else:
        cart_text = """<b>üõí –í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞</b>

–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞.
–í—ã–±–µ—Ä–∏—Ç–µ –±–ª—é–¥–∞ –∏–∑ –º–µ–Ω—é."""
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–æ—Ä–∑–∏–Ω–æ–π
    if user_id in cart_messages and cart_messages[user_id]:
        try:
            await bot.edit_message_text(
                chat_id=user_id,
                message_id=cart_messages[user_id],
                text=cart_text,
                reply_markup=kb.get_cart_menu(user_id),
                parse_mode="HTML"
            )
        except:
            # –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ
            msg = await bot.send_message(
                user_id,
                cart_text,
                reply_markup=kb.get_cart_menu(user_id),
                parse_mode="HTML"
            )
            cart_messages[user_id] = msg.message_id
    else:
        msg = await bot.send_message(
            user_id,
            cart_text,
            reply_markup=kb.get_cart_menu(user_id),
            parse_mode="HTML"
        )
        cart_messages[user_id] = msg.message_id

# === –ö–ù–û–ü–ö–ò –ù–ê–ó–ê–î ===
@router.callback_query(F.data == "back_main")
async def back_to_main(callback: CallbackQuery):
    """–í–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"""
    user_id = callback.from_user.id
    
    # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã –µ—Å–ª–∏ –µ—Å—Ç—å
    if user_id in cart_messages:
        try:
            await callback.bot.delete_message(user_id, cart_messages[user_id])
            del cart_messages[user_id]
        except:
            pass
    
    text = f"""<b>{RESTAURANT_NAME}</b>

–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:

<b>üçΩÔ∏è –ú–µ–Ω—é</b> - –ø–æ–ª–Ω–æ–µ –º–µ–Ω—é, –¥–æ—Å—Ç–∞–≤–∫–∞, —Å–∞–º–æ–≤—ã–≤–æ–∑
<b>üìÖ –ë—Ä–æ–Ω—å —Å—Ç–æ–ª–∏–∫–∞</b> - –æ–Ω–ª–∞–π–Ω-–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
<b>üè¢ –ì–∞–ª–µ—Ä–µ—è</b> - 3D-—Ç—É—Ä –∏ —Ñ–æ—Ç–æ
<b>‚≠ê –û—Ç–∑—ã–≤—ã</b> - —Ä–µ–π—Ç–∏–Ω–≥ –∏ –æ—Ç–∑—ã–≤—ã
<b>üí¨ –û–ø–µ—Ä–∞—Ç–æ—Ä</b> - —Å–≤—è–∑—å —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
<b>üì∞ –ù–æ–≤–æ—Å—Ç–∏</b> - –∞–∫—Ü–∏–∏ –∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è

<b>–ö–æ–Ω—Ç–∞–∫—Ç—ã:</b>
üìç {RESTAURANT_ADDRESS}
üìû {RESTAURANT_PHONE}
üïê {RESTAURANT_HOURS}
"""
    
    await callback.message.edit_text(text, reply_markup=kb.get_main_menu(), parse_mode="HTML")
    await callback.answer()

# === –†–ê–ó–î–ï–õ–´ ===
@router.callback_query(F.data == "menu_food")
async def menu_food(callback: CallbackQuery):
    """–†–∞–∑–¥–µ–ª –º–µ–Ω—é"""
    user_id = callback.from_user.id
    
    # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã –µ—Å–ª–∏ –µ—Å—Ç—å
    if user_id in cart_messages:
        try:
            await callback.bot.delete_message(user_id, cart_messages[user_id])
        except:
            pass
        cart_messages[user_id] = None
    
    text = """<b>üçΩÔ∏è –ú–µ–Ω—é –∏ –¥–æ—Å—Ç–∞–≤–∫–∞</b>

–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –º–µ–Ω—é, –¥–æ–±–∞–≤–∏—Ç—å –±–ª—é–¥–∞ –≤ –∫–æ—Ä–∑–∏–Ω—É –∏ –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑.

–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:"""
    
    await callback.message.edit_text(text, reply_markup=kb.get_food_menu(), parse_mode="HTML")
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É –µ—Å–ª–∏ –≤ –Ω–µ–π –µ—Å—Ç—å —Ç–æ–≤–∞—Ä—ã
    cart = db.get_user_cart(user_id)
    if cart:
        await show_cart_message(callback.bot, user_id)
    
    await callback.answer()

# === –í–û–ó–í–†–ê–¢ –í –ö–û–†–ó–ò–ù–£ –ò–ó –û–§–û–†–ú–õ–ï–ù–ò–Ø –ó–ê–ö–ê–ó–ê ===
@router.callback_query(F.data == "back_to_cart_action")
async def back_to_cart_action(callback: CallbackQuery):
    """–í–æ–∑–≤—Ä–∞—Ç –≤ –∫–æ—Ä–∑–∏–Ω—É –∏–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ –∏ –æ–ø–ª–∞—Ç—ã –æ–Ω–ª–∞–π–Ω"""
    user_id = callback.from_user.id
    
    # –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ —É–¥–∞–ª–µ–Ω–∏—è
    await show_cart_message(callback.bot, user_id)
    
    await callback.answer("–í–µ—Ä–Ω—É–ª–∏—Å—å –≤ –∫–æ—Ä–∑–∏–Ω—É")

# === –ë–†–û–ù–ò–†–û–í–ê–ù–ò–ï - —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ—Ö–æ–¥ –≤ –º–µ–Ω—é –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è ===
@router.callback_query(F.data == "menu_booking")
async def menu_booking(callback: CallbackQuery):
    """–†–∞–∑–¥–µ–ª –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è - —Ç–µ–ø–µ—Ä—å —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º –º–µ–Ω—é"""
    user_id = callback.from_user.id
    
    # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã
    if user_id in cart_messages:
        try:
            await callback.bot.delete_message(user_id, cart_messages[user_id])
            del cart_messages[user_id]
        except:
            pass
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω–∞—è –±—Ä–æ–Ω—å
    active_booking = db.get_user_active_booking(user_id)
    
    if active_booking:
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É
        from datetime import datetime
        booking_date = datetime.strptime(active_booking['date'], '%Y-%m-%d').strftime('%d.%m.%Y')
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω (—Å–∫—Ä—ã–≤–∞–µ–º —á–∞—Å—Ç—å —Ü–∏—Ñ—Ä)
        phone = active_booking['phone']
        if len(phone) >= 11:
            masked_phone = f"+7 XXX XXX {phone[-4:-2]} {phone[-2:]}"
        else:
            masked_phone = phone
        
        text = f"""<b>üìÖ –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–æ–ª–∏–∫–∞</b>

‚úÖ –£ –≤–∞—Å –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è –±—Ä–æ–Ω—å:

üìÖ <b>–î–∞—Ç–∞:</b> {booking_date}
üïê <b>–í—Ä–µ–º—è:</b> {active_booking['time']}:00
üìû <b>–¢–µ–ª–µ—Ñ–æ–Ω:</b> {masked_phone}
üë• <b>–ì–æ—Å—Ç–∏:</b> {active_booking['guests']} {get_guest_word(active_booking['guests'])}

–ß—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–¥–µ–ª–∞—Ç—å?"""
    else:
        text = f"""<b>üìÖ –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–æ–ª–∏–∫–∞</b>

–ó–∞–±—Ä–æ–Ω–∏—Ä—É–π—Ç–µ —Å—Ç–æ–ª–∏–∫ –æ–Ω–ª–∞–π–Ω –≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–ª–∏–∫–æ–≤!

–ü—Ä–æ—Ü–µ—Å—Å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:
1. üìÖ –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É
2. üïê –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è  
3. üë• –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ—Å—Ç–µ–π
4. üìû –í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω
5. ‚úÖ –ë—Ä–æ–Ω—å –≥–æ—Ç–æ–≤–∞!

–ò–ª–∏ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É: {RESTAURANT_PHONE}"""
    
    await callback.message.edit_text(
        text, 
        reply_markup=kb.get_booking_menu(has_active_booking=bool(active_booking)), 
        parse_mode="HTML"
    )
    await callback.answer()

# === –ù–ê–ß–ê–õ–û –ë–†–û–ù–ò–†–û–í–ê–ù–ò–Ø ===
@router.callback_query(F.data == "book_date")
async def book_date_start(callback: CallbackQuery):
    """–ù–∞—á–∞—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–Ω—é —Å –∫–Ω–æ–ø–∫–æ–π "–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–æ–ª–∏–∫"""
    user_id = callback.from_user.id
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω–∞—è –±—Ä–æ–Ω—å
    active_booking = db.get_user_active_booking(user_id)
    
    if active_booking:
        # –ï—Å–ª–∏ –µ—Å—Ç—å –±—Ä–æ–Ω—å - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        text = """<b>üìÖ –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–æ–ª–∏–∫–∞</b>

–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è –±—Ä–æ–Ω—å.

–í—ã –º–æ–∂–µ—Ç–µ –µ—ë –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ –æ—Ç–º–µ–Ω–∏—Ç—å."""
    else:
        # –ï—Å–ª–∏ –Ω–µ—Ç –±—Ä–æ–Ω–∏ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞—á–∞–ª–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        text = """<b>üìÖ –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–æ–ª–∏–∫</b>

–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ."""
    
    await callback.message.edit_text(
        text, 
        reply_markup=kb.get_booking_start_menu(), 
        parse_mode="HTML"
    )
    await callback.answer()

# === –ö–ù–û–ü–ö–ê "–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–æ–ª–∏–∫" ===
@router.callback_query(F.data == "book_date_select")
async def book_date_select(callback: CallbackQuery):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫—É "–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–æ–ª–∏–∫" - –≤–µ–¥–µ—Ç –Ω–∞ –≤—ã–±–æ—Ä –¥–∞—Ç—ã"""
    user_id = callback.from_user.id
    
    # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã –µ—Å–ª–∏ –µ—Å—Ç—å
    if user_id in cart_messages:
        try:
            await callback.bot.delete_message(user_id, cart_messages[user_id])
            del cart_messages[user_id]
        except:
            pass
    
    text = """<b>üìÖ –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É</b>

–î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–∞—Ç—ã –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:"""
    
    await callback.message.edit_text(text, reply_markup=kb.get_calendar_menu(), parse_mode="HTML")
    await callback.answer()

# === –û–§–û–†–ú–õ–ï–ù–ò–ï –ó–ê–ö–ê–ó–ê ===
@router.callback_query(F.data == "checkout")
async def checkout(callback: CallbackQuery):
    """–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞"""
    user_id = callback.from_user.id
    
    cart = db.get_user_cart(user_id)
    if not cart:
        await callback.answer("‚ùå –ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞")
        return
    
    cart_total = db.get_cart_total(user_id)
    delivery_cost = db.get_delivery_cost(user_id)
    total_with_delivery = cart_total + delivery_cost
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –∑–∞–∫–∞–∑–∞
    order_text = "<b>‚úÖ –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</b>\n\n"
    order_text += "<b>–í–∞—à –∑–∞–∫–∞–∑:</b>\n"
    
    for item in cart:
        item_total = item["price"] * item["quantity"]
        order_text += f"‚Ä¢ {item['name']}\n"
        order_text += f"  {item['quantity']} x {item['price']}‚ÇΩ = {item_total}‚ÇΩ\n"
    
    order_text += f"\n<b>–°—É–º–º–∞ –∑–∞–∫–∞–∑–∞:</b> {cart_total}‚ÇΩ"
    
    if delivery_cost > 0:
        order_text += f"\n<b>–î–æ—Å—Ç–∞–≤–∫–∞:</b> {delivery_cost}‚ÇΩ"
        order_text += f"\n<b>–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</b> {total_with_delivery}‚ÇΩ"
    else:
        order_text += f"\n<b>–î–æ—Å—Ç–∞–≤–∫–∞:</b> –±–µ—Å–ø–ª–∞—Ç–Ω–æ üéâ"
        order_text += f"\n<b>–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</b> {total_with_delivery}‚ÇΩ"
    
    order_text += f"\n\n<b>–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:</b>"
    
    await callback.message.edit_text(order_text, reply_markup=kb.get_checkout_menu(), parse_mode="HTML")
    await callback.answer()

# === –ö–ù–û–ü–ö–ê "food_cart" (–ø–æ–∫–∞–∑–∞—Ç—å –∫–æ—Ä–∑–∏–Ω—É) ===
@router.callback_query(F.data == "food_cart")
async def food_cart(callback: CallbackQuery):
    """–ü–æ–∫–∞–∑–∞—Ç—å –∫–æ—Ä–∑–∏–Ω—É"""
    user_id = callback.from_user.id
    
    # –ï—Å–ª–∏ –∫–æ—Ä–∑–∏–Ω—ã –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ–º –µ–µ
    if user_id not in cart_messages or not cart_messages[user_id]:
        await show_cart_message(callback.bot, user_id)
    
    await callback.answer()

@router.callback_query(F.data == "menu_gallery")
async def menu_gallery(callback: CallbackQuery):
    """–†–∞–∑–¥–µ–ª –≥–∞–ª–µ—Ä–µ–∏"""
    user_id = callback.from_user.id
    
    # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã
    if user_id in cart_messages:
        try:
            await callback.bot.delete_message(user_id, cart_messages[user_id])
            del cart_messages[user_id]
        except:
            pass
    
    text = """<b>üè¢ –ì–∞–ª–µ—Ä–µ—è</b>

–ü–æ–∑–Ω–∞–∫–æ–º—å—Ç–µ—Å—å —Å –Ω–∞—à–∏–º —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–º –ø–æ–±–ª–∏–∂–µ.

–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞:"""
    await callback.message.edit_text(text, reply_markup=kb.get_gallery_menu(), parse_mode="HTML")
    await callback.answer()

@router.callback_query(F.data == "menu_reviews")
async def menu_reviews(callback: CallbackQuery):
    """–†–∞–∑–¥–µ–ª –æ—Ç–∑—ã–≤–æ–≤"""
    user_id = callback.from_user.id
    
    # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã
    if user_id in cart_messages:
        try:
            await callback.bot.delete_message(user_id, cart_messages[user_id])
            del cart_messages[user_id]
        except:
            pass
    
    text = f"""<b>‚≠ê –û—Ç–∑—ã–≤—ã –∏ —Ä–µ–π—Ç–∏–Ω–≥</b>

–ù–∞—à —Ä–µ—Å—Ç–æ—Ä–∞–Ω –Ω–∞ –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç–∞—Ö:

<b>–†–µ–π—Ç–∏–Ω–≥:</b> 5.0/5
<b>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ü–µ–Ω–æ–∫:</b> 634 –æ—Ü–µ–Ω–∫–∏

–ß–∏—Ç–∞–π—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–µ –æ—Ç–∑—ã–≤—ã –Ω–∞—à–∏—Ö –≥–æ—Å—Ç–µ–π:"""
    
    await callback.message.edit_text(text, reply_markup=kb.get_reviews_menu(), parse_mode="HTML")
    await callback.answer()

@router.callback_query(F.data == "menu_operator")
async def menu_operator(callback: CallbackQuery):
    """–†–∞–∑–¥–µ–ª –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞"""
    user_id = callback.from_user.id
    
    # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã
    if user_id in cart_messages:
        try:
            await callback.bot.delete_message(user_id, cart_messages[user_id])
            del cart_messages[user_id]
        except:
            pass
    
    text = """<b>üí¨ –û–ø–µ—Ä–∞—Ç–æ—Ä –∏ —Å–ø—Ä–∞–≤–∫–∞</b>

–í—ã–±–µ—Ä–∏—Ç–µ –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –ø–æ–∑–æ–≤–∏—Ç–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞:"""
    await callback.message.edit_text(text, reply_markup=kb.get_operator_menu(), parse_mode="HTML")
    await callback.answer()

@router.callback_query(F.data == "menu_news")
async def menu_news(callback: CallbackQuery):
    """–†–∞–∑–¥–µ–ª –Ω–æ–≤–æ—Å—Ç–µ–π"""
    user_id = callback.from_user.id
    
    # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã
    if user_id in cart_messages:
        try:
            await callback.bot.delete_message(user_id, cart_messages[user_id])
            del cart_messages[user_id]
        except:
            pass
    
    text = f"""<b>üì∞ –ù–æ–≤–æ—Å—Ç–∏ –∏ –∞–∫—Ü–∏–∏</b>

–í—Å–µ –Ω–æ–≤–æ—Å—Ç–∏ –∏ –∞–∫—Ü–∏–∏ –≤ –Ω–∞—à–µ–º Telegram-–∫–∞–Ω–∞–ª–µ:

<a href="{TELEGRAM_CHANNEL}">üì¢ Mashkov_rest</a>

–ü–æ–¥–ø–∏—Å—ã–≤–∞–π—Ç–µ—Å—å, —á—Ç–æ–±—ã –±—ã—Ç—å –≤ –∫—É—Ä—Å–µ!"""
    
    await callback.message.edit_text(text, reply_markup=kb.get_news_menu(), parse_mode="HTML")
    await callback.answer()

# === –ü–û–î–†–ê–ó–î–ï–õ–´ –ú–ï–ù–Æ ===
@router.callback_query(F.data == "food_view")
async def food_view(callback: CallbackQuery):
    """–ü—Ä–æ—Å–º–æ—Ç—Ä –º–µ–Ω—é"""
    text = """<b>üìã –ù–∞—à–µ –º–µ–Ω—é</b>

–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:"""
    await callback.message.edit_text(text, reply_markup=kb.get_menu_categories(), parse_mode="HTML")
    await callback.answer()

@router.callback_query(F.data.startswith("cat_"))
async def show_category(callback: CallbackQuery):
    """–ü–æ–∫–∞–∑–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é –º–µ–Ω—é —Å —Ç–æ–≤–∞—Ä–∞–º–∏"""
    category = callback.data.split("_")[1]
    
    if category == "salads":
        text = """<b>ü•ó –°–∞–ª–∞—Ç—ã</b>

<b>–¶–µ–∑–∞—Ä—å —Å –∫—Ä–µ–≤–µ—Ç–∫–∞–º–∏</b>
<code>680‚ÇΩ</code>

<b>–ì—Ä–µ—á–µ—Å–∫–∏–π</b>
<code>820‚ÇΩ</code>"""
        
        keyboard = InlineKeyboardMarkup(
            inline_keyboard=[
                [
                    InlineKeyboardButton(text="‚ûï –¶–µ–∑–∞—Ä—å —Å –∫—Ä–µ–≤–µ—Ç–∫–∞–º–∏", 
                                       callback_data="add_to_cart_salad_caesar"),
                    InlineKeyboardButton(text="‚ûï –ì—Ä–µ—á–µ—Å–∫–∏–π", 
                                       callback_data="add_to_cart_salad_greek"),
                ],
                [
                    InlineKeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="food_view")
                ]
            ]
        )
    
    elif category == "soups":
        text = """<b>üç≤ –°—É–ø—ã</b>

<b>–¢–æ–º–∞—Ç–Ω—ã–π —Å—É–ø</b>
<code>650‚ÇΩ</code>

<b>–ë–æ—Ä—â</b>
<code>550‚ÇΩ</code>"""
        
        keyboard = InlineKeyboardMarkup(
            inline_keyboard=[
                [
                    InlineKeyboardButton(text="‚ûï –¢–æ–º–∞—Ç–Ω—ã–π —Å—É–ø", 
                                       callback_data="add_to_cart_soup_tomato"),
                    InlineKeyboardButton(text="‚ûï –ë–æ—Ä—â", 
                                       callback_data="add_to_cart_soup_borsch"),
                ],
                [
                    InlineKeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="food_view")
                ]
            ]
        )
    
    elif category == "hot":
        text = """<b>üçñ –ì–æ—Ä—è—á–µ–µ</b>

<b>–°—Ç–µ–π–∫ –†–∏–±–∞–π</b>
<code>1200‚ÇΩ</code>

<b>–£—Ç–∫–∞ —Å —è–±–ª–æ–∫–∞–º–∏</b>
<code>950‚ÇΩ</code>"""
        
        keyboard = InlineKeyboardMarkup(
            inline_keyboard=[
                [
                    InlineKeyboardButton(text="‚ûï –°—Ç–µ–π–∫ –†–∏–±–∞–π", 
                                       callback_data="add_to_cart_steak_ribeye"),
                    InlineKeyboardButton(text="‚ûï –£—Ç–∫–∞ —Å —è–±–ª–æ–∫–∞–º–∏", 
                                       callback_data="add_to_cart_duck_apple"),
                ],
                [
                    InlineKeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="food_view")
                ]
            ]
        )
    
    else:  # desserts
        text = """<b>üç∞ –î–µ—Å–µ—Ä—Ç—ã</b>

<b>–¢–∏—Ä–∞–º–∏—Å—É</b>
<code>350‚ÇΩ</code>

<b>–ß–∏–∑–∫–µ–π–∫</b>
<code>380‚ÇΩ</code>"""
        
        keyboard = InlineKeyboardMarkup(
            inline_keyboard=[
                [
                    InlineKeyboardButton(text="‚ûï –¢–∏—Ä–∞–º–∏—Å—É", 
                                       callback_data="add_to_cart_tiramisu"),
                    InlineKeyboardButton(text="‚ûï –ß–∏–∑–∫–µ–π–∫", 
                                       callback_data="add_to_cart_cheesecake"),
                ],
                [
                    InlineKeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="food_view")
                ]
            ]
        )
    
    await callback.message.edit_text(text, reply_markup=keyboard, parse_mode="HTML")
    await callback.answer()

# === –ö–û–†–ó–ò–ù–ê ===
@router.callback_query(F.data.startswith("add_to_cart_"))
async def add_to_cart(callback: CallbackQuery):
    """–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä –≤ –∫–æ—Ä–∑–∏–Ω—É"""
    user_id = callback.from_user.id
    item_id = callback.data.split("add_to_cart_")[1]
    
    success = db.add_to_cart(user_id, item_id)
    
    if success:
        item = db.menu_items.get(item_id)
        await callback.answer(f"‚úÖ {item['name']} –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É!")
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–æ—Ä–∑–∏–Ω–æ–π
        await show_cart_message(callback.bot, user_id)
    else:
        await callback.answer("‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ—Ä–∑–∏–Ω—É")

@router.callback_query(F.data.startswith("cart_plus_"))
async def cart_plus(callback: CallbackQuery):
    """–£–≤–µ–ª–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω–µ"""
    user_id = callback.from_user.id
    item_id = callback.data.split("cart_plus_")[1]
    
    cart = db.get_user_cart(user_id)
    for item in cart:
        if item["id"] == item_id:
            db.update_quantity(user_id, item_id, item["quantity"] + 1)
            await callback.answer(f"‚ûï {item['name']} –¥–æ–±–∞–≤–ª–µ–Ω")
            
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–æ—Ä–∑–∏–Ω–æ–π
            await show_cart_message(callback.bot, user_id)
            break

@router.callback_query(F.data.startswith("cart_minus_"))
async def cart_minus(callback: CallbackQuery):
    """–£–º–µ–Ω—å—à–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω–µ"""
    user_id = callback.from_user.id
    item_id = callback.data.split("cart_minus_")[1]
    
    cart = db.get_user_cart(user_id)
    for item in cart:
        if item["id"] == item_id:
            new_quantity = item["quantity"] - 1
            if new_quantity > 0:
                db.update_quantity(user_id, item_id, new_quantity)
                await callback.answer(f"‚ûñ {item['name']} —É–±—Ä–∞–Ω")
            else:
                db.remove_from_cart(user_id, item_id)
                await callback.answer(f"üóëÔ∏è {item['name']} —É–¥–∞–ª–µ–Ω")
            
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–æ—Ä–∑–∏–Ω–æ–π
            await show_cart_message(callback.bot, user_id)
            break

@router.callback_query(F.data == "cart_clear")
async def cart_clear(callback: CallbackQuery):
    """–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É"""
    user_id = callback.from_user.id
    db.clear_cart(user_id)
    
    await callback.answer("üóëÔ∏è –ö–æ—Ä–∑–∏–Ω–∞ –æ—á–∏—â–µ–Ω–∞")
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–æ—Ä–∑–∏–Ω–æ–π
    await show_cart_message(callback.bot, user_id)

# === –û–ü–õ–ê–¢–ê ===
@router.callback_query(F.data == "payment_cash")
async def payment_cash(callback: CallbackQuery):
    """–û–ø–ª–∞—Ç–∞ –Ω–∞–ª–∏—á–Ω—ã–º–∏"""
    user_id = callback.from_user.id
    
    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–æ—Ä–∑–∏–Ω—ã –ø–µ—Ä–µ–¥ –æ—á–∏—Å—Ç–∫–æ–π
    cart_total = db.get_cart_total(user_id)
    delivery_cost = db.get_delivery_cost(user_id)
    total_with_delivery = cart_total + delivery_cost
    
    text = f"""<b>üíµ –û–ø–ª–∞—Ç–∞ –Ω–∞–ª–∏—á–Ω—ã–º–∏ –∫—É—Ä—å–µ—Ä—É</b>

–ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω! 

<b>–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</b> {total_with_delivery}‚ÇΩ

–ö—É—Ä—å–µ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π –∏ –≤—Ä–µ–º–µ–Ω–∏ –¥–æ—Å—Ç–∞–≤–∫–∏.

–°–ø–∞—Å–∏–±–æ –∑–∞ –∑–∞–∫–∞–∑! üòä"""
    
    # –û—á–∏—â–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É
    db.clear_cart(user_id)
    
    # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã
    if user_id in cart_messages:
        try:
            await callback.bot.delete_message(user_id, cart_messages[user_id])
            del cart_messages[user_id]
        except:
            pass
    
    # –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞) –≤–º–µ—Å—Ç–æ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ
    try:
        await callback.message.edit_text(text, reply_markup=kb.get_back_button("menu_food"), parse_mode="HTML")
    except:
        # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        await callback.message.answer(text, reply_markup=kb.get_back_button("menu_food"), parse_mode="HTML")
    
    await callback.answer()

@router.callback_query(F.data == "payment_card")
async def payment_card(callback: CallbackQuery):
    """–û–ø–ª–∞—Ç–∞ –∫–∞—Ä—Ç–æ–π –∫—É—Ä—å–µ—Ä—É"""
    user_id = callback.from_user.id
    
    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–æ—Ä–∑–∏–Ω—ã –ø–µ—Ä–µ–¥ –æ—á–∏—Å—Ç–∫–æ–π
    cart_total = db.get_cart_total(user_id)
    delivery_cost = db.get_delivery_cost(user_id)
    total_with_delivery = cart_total + delivery_cost
    
    text = f"""<b>üí≥ –û–ø–ª–∞—Ç–∞ –∫–∞—Ä—Ç–æ–π –∫—É—Ä—å–µ—Ä—É</b>

–ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω! 

<b>–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</b> {total_with_delivery}‚ÇΩ

–ö—É—Ä—å–µ—Ä –ø—Ä–∏–≤–µ–∑–µ—Ç —Ç–µ—Ä–º–∏–Ω–∞–ª –¥–ª—è –æ–ø–ª–∞—Ç—ã.

–°–ø–∞—Å–∏–±–æ –∑–∞ –∑–∞–∫–∞–∑! üòä"""
    
    # –û—á–∏—â–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É
    db.clear_cart(user_id)
    
    # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã
    if user_id in cart_messages:
        try:
            await callback.bot.delete_message(user_id, cart_messages[user_id])
            del cart_messages[user_id]
        except:
            pass
    
    # –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞) –≤–º–µ—Å—Ç–æ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ
    try:
        await callback.message.edit_text(text, reply_markup=kb.get_back_button("menu_food"), parse_mode="HTML")
    except:
        # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        await callback.message.answer(text, reply_markup=kb.get_back_button("menu_food"), parse_mode="HTML")
    
    await callback.answer()

@router.callback_query(F.data == "payment_now")
async def payment_now(callback: CallbackQuery):
    """–û–ø–ª–∞—Ç–∏—Ç—å —Å–µ–π—á–∞—Å –æ–Ω–ª–∞–π–Ω"""
    user_id = callback.from_user.id
    
    cart_total = db.get_cart_total(user_id)
    delivery_cost = db.get_delivery_cost(user_id)
    total_with_delivery = cart_total + delivery_cost
    
    text = f"""<b>üí≥ –û–ø–ª–∞—Ç–∏—Ç—å –æ–Ω–ª–∞–π–Ω</b>

<b>–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</b> {total_with_delivery}‚ÇΩ

–î–ª—è –æ–ø–ª–∞—Ç—ã –æ–Ω–ª–∞–π–Ω –ø–æ–∑–≤–æ–Ω–∏—Ç–µ –Ω–∞–º:

üìû +7 (903) 748-80-80

–ú—ã –æ—Ç–ø—Ä–∞–≤–∏–º –≤–∞–º —Å—Å—ã–ª–∫—É –¥–ª—è –æ–ø–ª–∞—Ç—ã."""
    
    # –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞) –≤–º–µ—Å—Ç–æ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ
    try:
        await callback.message.edit_text(text, reply_markup=kb.get_back_to_cart(), parse_mode="HTML")
    except:
        # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        await callback.message.answer(text, reply_markup=kb.get_back_to_cart(), parse_mode="HTML")
    
    await callback.answer("–ü–æ–∑–≤–æ–Ω–∏—Ç–µ –¥–ª—è –æ–ø–ª–∞—Ç—ã")

# === –û–ü–ï–†–ê–¢–û–† ===
@router.callback_query(F.data == "op_hours")
async def op_hours(callback: CallbackQuery):
    """–ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã"""
    text = f"""<b>üïê –ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã</b>

<b>–†–µ—Å—Ç–æ—Ä–∞–Ω:</b>
{RESTAURANT_HOURS}"""
    
    await callback.message.edit_text(text, reply_markup=kb.get_back_button("menu_operator"), parse_mode="HTML")
    await callback.answer()

@router.callback_query(F.data == "op_address")
async def op_address(callback: CallbackQuery):
    """–ê–¥—Ä–µ—Å"""
    text = f"""<b>üìç –ê–¥—Ä–µ—Å</b>

<b>–ê–¥—Ä–µ—Å —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞:</b>
{RESTAURANT_ADDRESS}

<b>–¢–µ–ª–µ—Ñ–æ–Ω:</b>
{RESTAURANT_PHONE}"""
    
    await callback.message.edit_text(text, reply_markup=kb.get_back_button("menu_operator"), parse_mode="HTML")
    await callback.answer()

@router.callback_query(F.data == "op_delivery")
async def op_delivery(callback: CallbackQuery):
    """–£—Å–ª–æ–≤–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏"""
    text = f"""<b>üöö –£—Å–ª–æ–≤–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏</b>

<b>–í—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏:</b>
‚Ä¢ {DELIVERY_TIME}

<b>–°—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏:</b>
‚Ä¢ {DELIVERY_COST}‚ÇΩ (–±–µ—Å–ø–ª–∞—Ç–Ω–æ –æ—Ç {FREE_DELIVERY_MIN}‚ÇΩ)

<b>–°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã:</b>
‚Ä¢ –ö–∞—Ä—Ç–æ–π –∫—É—Ä—å–µ—Ä—É
‚Ä¢ –ù–∞–ª–∏—á–Ω—ã–º–∏"""
    
    await callback.message.edit_text(text, reply_markup=kb.get_back_button("menu_operator"), parse_mode="HTML")
    await callback.answer()

@router.callback_query(F.data == "op_call")
async def op_call(callback: CallbackQuery):
    """–ü–æ–∑–≤–∞—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞"""
    text = f"""<b>üìû –°–≤—è–∑—å —Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º</b>

–í–∞—à –∑–∞–ø—Ä–æ—Å –ø–µ—Ä–µ–¥–∞–Ω –æ–ø–µ—Ä–∞—Ç–æ—Ä—É.

–û–∂–∏–¥–∞–π—Ç–µ –æ—Ç–≤–µ—Ç–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ 5 –º–∏–Ω—É—Ç.

–ò–ª–∏ –ø–æ–∑–≤–æ–Ω–∏—Ç–µ –Ω–∞–ø—Ä—è–º—É—é:
{RESTAURANT_PHONE}"""
    
    await callback.message.edit_text(text, reply_markup=kb.get_back_button("menu_operator"), parse_mode="HTML")
    await callback.answer("–ó–∞–ø—Ä–æ—Å –ø–µ—Ä–µ–¥–∞–Ω –æ–ø–µ—Ä–∞—Ç–æ—Ä—É")

# === –ì–ê–õ–ï–†–ï–Ø ===
@router.callback_query(F.data == "gallery_photos")
async def gallery_photos(callback: CallbackQuery):
    """–§–æ—Ç–æ–≥–∞–ª–µ—Ä–µ—è"""
    text = """<b>üì∏ –§–æ—Ç–æ–≥–∞–ª–µ—Ä–µ—è</b>

–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ –∏ –±–ª—é–¥.

*–§–æ—Ç–æ–≥–∞–ª–µ—Ä–µ—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ*"""
    
    await callback.message.edit_text(text, reply_markup=kb.get_back_button("menu_gallery"), parse_mode="HTML")
    await callback.answer("–§–æ—Ç–æ–≥–∞–ª–µ—Ä–µ—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ")

# === NO ACTION ===
@router.callback_query(F.data == "no_action")
async def no_action(callback: CallbackQuery):
    """–ü—É—Å—Ç–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –¥–ª—è –∫–Ω–æ–ø–æ–∫-–∑–∞–≥–ª—É—à–µ–∫"""
    await callback.answer()


"""
keyboards/calendar.py
–ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã –¥–ª—è –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏
"""

from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from datetime import datetime, timedelta

def get_calendar_menu():
    """–ö–∞–ª–µ–Ω–¥–∞—Ä—å –¥–ª—è –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã"""
    today = datetime.now()
    keyboard = []
    
    # –î–æ–±–∞–≤–ª—è–µ–º –¥–∞—Ç—ã –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–µ 14 –¥–Ω–µ–π
    for i in range(14):
        date = today + timedelta(days=i)
        date_str = date.strftime("%d.%m.%Y")
        callback_data = f"date_{date.strftime('%Y-%m-%d')}"
        
        if i == 0:
            label = f"üóìÔ∏è –°–µ–≥–æ–¥–Ω—è ({date_str})"
        elif i == 1:
            label = f"üóìÔ∏è –ó–∞–≤—Ç—Ä–∞ ({date_str})"
        else:
            day_name = ["–ü–Ω", "–í—Ç", "–°—Ä", "–ß—Ç", "–ü—Ç", "–°–±", "–í—Å"][date.weekday()]
            label = f"üóìÔ∏è {day_name} {date_str}"
        
        keyboard.append([InlineKeyboardButton(text=label, callback_data=callback_data)])
    
    keyboard.append([InlineKeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="menu_booking")])
    
    return InlineKeyboardMarkup(inline_keyboard=keyboard)

def get_time_menu():
    """–í—ã–±–æ—Ä –≤—Ä–µ–º–µ–Ω–∏"""
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [
                InlineKeyboardButton(text="üïê 12:00", callback_data="time_12:00"),
                InlineKeyboardButton(text="üïê 13:00", callback_data="time_13:00"),
                InlineKeyboardButton(text="üïê 14:00", callback_data="time_14:00"),
            ],
            [
                InlineKeyboardButton(text="üïê 15:00", callback_data="time_15:00"),
                InlineKeyboardButton(text="üïê 16:00", callback_data="time_16:00"),
                InlineKeyboardButton(text="üïê 17:00", callback_data="time_17:00"),
            ],
            [
                InlineKeyboardButton(text="üïê 18:00", callback_data="time_18:00"),
                InlineKeyboardButton(text="üïê 19:00", callback_data="time_19:00"),
                InlineKeyboardButton(text="üïê 20:00", callback_data="time_20:00"),
            ],
            [
                InlineKeyboardButton(text="üïê 21:00", callback_data="time_21:00"),
                InlineKeyboardButton(text="üïê 22:00", callback_data="time_22:00"),
            ],
            [
                InlineKeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="book_date_select")
            ]
        ]
    )

"""
handlers/booking_handlers.py
–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
"""

from aiogram import Router, F
from aiogram.types import CallbackQuery, Message, InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.filters import StateFilter
from aiogram.fsm.state import State, StatesGroup
from aiogram.fsm.context import FSMContext
from datetime import datetime, timedelta
import re
import keyboards as kb
import database as db
from config import RESTAURANT_PHONE

router = Router()

# –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è FSM
class BookingStates(StatesGroup):
    waiting_for_phone = State()
    confirming_booking = State()

# –•—Ä–∞–Ω–∏–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è {user_id: {date, time, guests, phone}}
temp_booking_data = {}
def get_guest_word(count):
    """–ü–æ–ª—É—á–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–ª–æ–≤–æ –¥–ª—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≥–æ—Å—Ç–µ–π"""
    if count == 1:
        return "–≥–æ—Å—Ç—å"
    elif 2 <= count <= 4:
        return "–≥–æ—Å—Ç—è"
    else:
        return "–≥–æ—Å—Ç–µ–π"
# === –í–´–ë–û–† –î–ê–¢–´ ===
@router.callback_query(F.data.startswith("date_"))
async def select_date(callback: CallbackQuery):
    """–í—ã–±–æ—Ä –¥–∞—Ç—ã"""
    user_id = callback.from_user.id
    date_str = callback.data.split("date_")[1]
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    if user_id not in temp_booking_data:
        temp_booking_data[user_id] = {}
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞—Ç—É
    temp_booking_data[user_id]['date'] = date_str
    
    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    date_obj = datetime.strptime(date_str, '%Y-%m-%d')
    formatted_date = date_obj.strftime('%d.%m.%Y')
    
    text = f"""<b>üïê –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è</b>

–í—ã–±—Ä–∞–Ω–∞ –¥–∞—Ç–∞: <b>{formatted_date}</b>

–î–æ—Å—Ç—É–ø–Ω–æ–µ –≤—Ä–µ–º—è:"""
    
    await callback.message.edit_text(text, reply_markup=kb.get_time_menu(), parse_mode="HTML")
    await callback.answer(f"–î–∞—Ç–∞: {formatted_date}")

# === –í–´–ë–û–† –í–†–ï–ú–ï–ù–ò ===
@router.callback_query(F.data.startswith("time_"))
async def select_time(callback: CallbackQuery):
    """–í—ã–±–æ—Ä –≤—Ä–µ–º–µ–Ω–∏"""
    user_id = callback.from_user.id
    time_str = callback.data.split("time_")[1]  # —Ñ–æ—Ä–º–∞—Ç "HH:MM"
    
    if user_id not in temp_booking_data or 'date' not in temp_booking_data[user_id]:
        await callback.answer("‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É")
        return
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º—è
    temp_booking_data[user_id]['time'] = time_str
    
    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    date_str = temp_booking_data[user_id]['date']
    date_obj = datetime.strptime(date_str, '%Y-%m-%d')
    formatted_date = date_obj.strftime('%d.%m.%Y')
    
    text = f"""<b>üë• –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ—Å—Ç–µ–π</b>

–í—ã–±—Ä–∞–Ω–∞ –¥–∞—Ç–∞: <b>{formatted_date}</b>
–í—ã–±—Ä–∞–Ω–æ –≤—Ä–µ–º—è: <b>{time_str}:00</b>

–°–∫–æ–ª—å–∫–æ –±—É–¥–µ—Ç –≥–æ—Å—Ç–µ–π?"""
    
    await callback.message.edit_text(text, reply_markup=kb.get_guests_menu(), parse_mode="HTML")
    await callback.answer(f"–í—Ä–µ–º—è: {time_str}:00")

# === –ù–ê–ó–ê–î –ö –í–´–ë–û–†–£ –í–†–ï–ú–ï–ù–ò ===
@router.callback_query(F.data == "select_time_back")
async def select_time_back(callback: CallbackQuery):
    """–ù–∞–∑–∞–¥ –∫ –≤—ã–±–æ—Ä—É –≤—Ä–µ–º–µ–Ω–∏"""
    user_id = callback.from_user.id
    
    if user_id in temp_booking_data:
        # –£–¥–∞–ª—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è
        if 'time' in temp_booking_data[user_id]:
            del temp_booking_data[user_id]['time']
        if 'guests' in temp_booking_data[user_id]:
            del temp_booking_data[user_id]['guests']
    
    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    if user_id in temp_booking_data and 'date' in temp_booking_data[user_id]:
        date_str = temp_booking_data[user_id]['date']
        date_obj = datetime.strptime(date_str, '%Y-%m-%d')
        formatted_date = date_obj.strftime('%d.%m.%Y')
        
        text = f"""<b>üïê –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è</b>

–í—ã–±—Ä–∞–Ω–∞ –¥–∞—Ç–∞: <b>{formatted_date}</b>

–î–æ—Å—Ç—É–ø–Ω–æ–µ –≤—Ä–µ–º—è:"""
        
        await callback.message.edit_text(text, reply_markup=kb.get_time_menu(), parse_mode="HTML")
    
    await callback.answer()

# === –í–´–ë–û–† –ö–û–õ–ò–ß–ï–°–¢–í–ê –ì–û–°–¢–ï–ô ===
@router.callback_query(F.data.startswith("guests_"))
async def select_guests(callback: CallbackQuery, state: FSMContext):
    """–í—ã–±–æ—Ä –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≥–æ—Å—Ç–µ–π"""
    user_id = callback.from_user.id
    guests_count = int(callback.data.split("_")[1])  # 1, 2, 3, 4, 5, 6
    
    if user_id not in temp_booking_data or 'date' not in temp_booking_data[user_id] or 'time' not in temp_booking_data[user_id]:
        await callback.answer("‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è")
        return
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ—Å—Ç–µ–π
    temp_booking_data[user_id]['guests'] = guests_count
    
    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    date_str = temp_booking_data[user_id]['date']
    date_obj = datetime.strptime(date_str, '%Y-%m-%d')
    formatted_date = date_obj.strftime('%d.%m.%Y')
    
    text = f"""<b>üìû –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</b>

<b>–î–∞–Ω–Ω—ã–µ –±—Ä–æ–Ω–∏:</b>
üìÖ –î–∞—Ç–∞: {formatted_date}
üïê –í—Ä–µ–º—è: {temp_booking_data[user_id]['time']}:00
üë• –ì–æ—Å—Ç–∏: {guests_count} {get_guest_word(guests_count)}

<b>–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:</b>
<code>+7 XXX XXX XX XX</code>

–ü—Ä–∏–º–µ—Ä: <code>+7 912 345 67 89</code>"""
    
    await callback.message.edit_text(text, parse_mode="HTML")
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    message_id = callback.message.message_id
    await state.update_data(message_id=message_id, chat_id=callback.message.chat.id)
    
    # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    await state.set_state(BookingStates.waiting_for_phone)
    await callback.answer(f"–ì–æ—Å—Ç–∏: {guests_count}")

# === –ù–ê–ó–ê–î –ö –í–´–ë–û–†–£ –ì–û–°–¢–ï–ô ===
@router.callback_query(F.data == "select_guests_back")
async def select_guests_back(callback: CallbackQuery, state: FSMContext):
    """–ù–∞–∑–∞–¥ –∫ –≤—ã–±–æ—Ä—É –≥–æ—Å—Ç–µ–π"""
    user_id = callback.from_user.id
    
    if user_id in temp_booking_data:
        # –£–¥–∞–ª—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –≥–æ—Å—Ç–µ–π –∏ —Ç–µ–ª–µ—Ñ–æ–Ω
        if 'guests' in temp_booking_data[user_id]:
            del temp_booking_data[user_id]['guests']
        if 'phone' in temp_booking_data[user_id]:
            del temp_booking_data[user_id]['phone']
    
    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    if user_id in temp_booking_data and 'date' in temp_booking_data[user_id] and 'time' in temp_booking_data[user_id]:
        date_str = temp_booking_data[user_id]['date']
        date_obj = datetime.strptime(date_str, '%Y-%m-%d')
        formatted_date = date_obj.strftime('%d.%m.%Y')
        
        text = f"""<b>üë• –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ—Å—Ç–µ–π</b>

–í—ã–±—Ä–∞–Ω–∞ –¥–∞—Ç–∞: <b>{formatted_date}</b>
–í—ã–±—Ä–∞–Ω–æ –≤—Ä–µ–º—è: <b>{temp_booking_data[user_id]['time']}:00</b>

–°–∫–æ–ª—å–∫–æ –±—É–¥–µ—Ç –≥–æ—Å—Ç–µ–π?"""
        
        await callback.message.edit_text(text, reply_markup=kb.get_guests_menu(), parse_mode="HTML")
    
    # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    await state.clear()
    await callback.answer()

# === –í–í–û–î –¢–ï–õ–ï–§–û–ù–ê (—Å–æ—Å—Ç–æ—è–Ω–∏–µ) ===
@router.message(BookingStates.waiting_for_phone)
async def process_phone(message: Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ - –û–ë–ù–û–í–õ–Ø–ï–ú —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"""
    user_id = message.from_user.id
    
    if user_id not in temp_booking_data:
        await message.answer("‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É, –≤—Ä–µ–º—è –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ—Å—Ç–µ–π")
        await state.clear()
        return
    
    phone = message.text.strip()
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    phone_regex = r'^\+7\s?\d{3}\s?\d{3}\s?\d{2}\s?\d{2}$|^\+7\d{10}$|^8\d{10}$|^7\d{10}$'
    
    if not re.match(phone_regex, phone):
        # –ü–æ–ª—É—á–∞–µ–º ID —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        state_data = await state.get_data()
        message_id = state_data.get('message_id')
        chat_id = state_data.get('chat_id')
        
        if message_id and chat_id:
            try:
                # –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                await message.bot.edit_message_text(
                    chat_id=chat_id,
                    message_id=message_id,
                    text=f"""<b>üìû –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</b>

<b>–î–∞–Ω–Ω—ã–µ –±—Ä–æ–Ω–∏:</b>
üìÖ –î–∞—Ç–∞: {datetime.strptime(temp_booking_data[user_id]['date'], '%Y-%m-%d').strftime('%d.%m.%Y')}
üïê –í—Ä–µ–º—è: {temp_booking_data[user_id]['time']}:00
üë• –ì–æ—Å—Ç–∏: {temp_booking_data[user_id]['guests']} {get_guest_word(temp_booking_data[user_id]['guests'])}

<b>‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞!</b>

<b>–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:</b>
<code>+7 XXX XXX XX XX</code>

–ü—Ä–∏–º–µ—Ä: <code>+7 912 345 67 89</code>""",
                    parse_mode="HTML"
                )
            except:
                pass
        
        # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –≤–≤–æ–¥–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        try:
            await message.delete()
        except:
            pass
        
        return
    
    # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω (—É–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã, –ø—Ä–∏–≤–æ–¥–∏–º –∫ —Ñ–æ—Ä–º–∞—Ç—É +7XXXXXXXXXX)
    phone_clean = phone.replace(" ", "").replace("-", "").replace("(", "").replace(")", "")
    if phone_clean.startswith("8"):
        phone_clean = "+7" + phone_clean[1:]
    elif phone_clean.startswith("7"):
        phone_clean = "+" + phone_clean
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω
    temp_booking_data[user_id]['phone'] = phone_clean
    
    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    date_str = temp_booking_data[user_id]['date']
    date_obj = datetime.strptime(date_str, '%Y-%m-%d')
    formatted_date = date_obj.strftime('%d.%m.%Y')
    
    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è (—Å–∫—Ä—ã–≤–∞–µ–º —á–∞—Å—Ç—å —Ü–∏—Ñ—Ä)
    if len(phone_clean) >= 11:
        masked_phone = f"+7 XXX XXX {phone_clean[-4:-2]} {phone_clean[-2:]}"
    else:
        masked_phone = phone_clean
    
    # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –≤–≤–æ–¥–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    try:
        await message.delete()
    except:
        pass
    
    # –ü–æ–ª—É—á–∞–µ–º ID —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    state_data = await state.get_data()
    message_id = state_data.get('message_id')
    chat_id = state_data.get('chat_id')
    
    if message_id and chat_id:
        try:
            text = f"""<b>‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</b>

<b>–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ:</b>
üìÖ <b>–î–∞—Ç–∞:</b> {formatted_date}
üïê <b>–í—Ä–µ–º—è:</b> {temp_booking_data[user_id]['time']}:00
üìû <b>–¢–µ–ª–µ—Ñ–æ–Ω:</b> {masked_phone}
üë• <b>–ì–æ—Å—Ç–∏:</b> {temp_booking_data[user_id]['guests']} {get_guest_word(temp_booking_data[user_id]['guests'])}

<b>–ù–∞–∂–º–∏—Ç–µ "‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ" –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è.</b>

–ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–∂–∏–¥–∞–π—Ç–µ –∑–≤–æ–Ω–∫–∞ –æ—Ç –Ω–∞—à–µ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞."""
            
            await message.bot.edit_message_text(
                chat_id=chat_id,
                message_id=message_id,
                text=text,
                reply_markup=kb.get_booking_confirmation_menu(),
                parse_mode="HTML"
            )
        except Exception as e:
            # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            await message.answer(text, reply_markup=kb.get_booking_confirmation_menu(), parse_mode="HTML")
    
    # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    await state.clear()

# === –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï –ë–†–û–ù–ò–†–û–í–ê–ù–ò–Ø ===
@router.callback_query(F.data == "booking_final_confirm")
async def booking_final_confirm(callback: CallbackQuery):
    """–§–∏–Ω–∞–ª—å–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è"""
    user_id = callback.from_user.id
    
    if user_id not in temp_booking_data:
        await callback.answer("‚ùå –î–∞–Ω–Ω—ã–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
        return
    
    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    booking_data = temp_booking_data[user_id]
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Å–µ –ª–∏ –¥–∞–Ω–Ω—ã–µ –µ—Å—Ç—å
    required_fields = ['date', 'time', 'guests', 'phone']
    for field in required_fields:
        if field not in booking_data:
            await callback.answer(f"‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç {field}")
            return
    
    # –°–æ–∑–¥–∞–µ–º –±—Ä–æ–Ω—å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    try:
        booking_id = db.create_booking(
            user_id=user_id,
            date=booking_data['date'],
            time=booking_data['time'],
            phone=booking_data['phone'],
            guests=booking_data['guests']
        )
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        date_obj = datetime.strptime(booking_data['date'], '%Y-%m-%d')
        formatted_date = date_obj.strftime('%d.%m.%Y')
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        phone = booking_data['phone']
        if len(phone) >= 11:
            masked_phone = f"+7 XXX XXX {phone[-4:-2]} {phone[-2:]}"
        else:
            masked_phone = phone
        
        text = f"""<b>üéâ –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ!</b>

‚úÖ –í–∞—à —Å—Ç–æ–ª–∏–∫ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω.

<b>–î–µ—Ç–∞–ª–∏ –±—Ä–æ–Ω–∏:</b>
üìÖ <b>–î–∞—Ç–∞:</b> {formatted_date}
üïê <b>–í—Ä–µ–º—è:</b> {booking_data['time']}:00
üìû <b>–¢–µ–ª–µ—Ñ–æ–Ω:</b> {masked_phone}
üë• <b>–ì–æ—Å—Ç–∏:</b> {booking_data['guests']} {get_guest_word(booking_data['guests'])}

<b>–û–∂–∏–¥–∞–π—Ç–µ –∑–≤–æ–Ω–∫–∞ –æ—Ç –Ω–∞—à–µ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.</b>

–í—ã –º–æ–∂–µ—Ç–µ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ –æ—Ç–º–µ–Ω–∏—Ç—å –±—Ä–æ–Ω—å –≤ –º–µ–Ω—é "üìÖ –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–æ–ª–∏–∫–∞"."""
        
        await callback.message.edit_text(text, reply_markup=kb.get_back_button("menu_booking"), parse_mode="HTML")
        
        # –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        if user_id in temp_booking_data:
            del temp_booking_data[user_id]
            
    except Exception as e:
        await callback.answer("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –±—Ä–æ–Ω–∏")
        text = "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –±—Ä–æ–Ω–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –ø–æ–∑–≤–æ–Ω–∏—Ç–µ –Ω–∞–º: " + RESTAURANT_PHONE
        await callback.message.edit_text(text, reply_markup=kb.get_back_button("menu_booking"))
    
    await callback.answer()

# === –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –ë–†–û–ù–ò ===
@router.callback_query(F.data == "book_edit")
async def book_edit(callback: CallbackQuery):
    """–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –±—Ä–æ–Ω—å (–Ω–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–Ω–æ–≤–æ)"""
    user_id = callback.from_user.id
    
    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –±—Ä–æ–Ω—å
    active_booking = db.get_user_active_booking(user_id)
    if not active_booking:
        await callback.answer("‚ùå –ê–∫—Ç–∏–≤–Ω–∞—è –±—Ä–æ–Ω—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
        return
    
    # –û—Ç–º–µ–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –±—Ä–æ–Ω—å
    db.cancel_booking(active_booking['id'])
    
    # –ù–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    text = """<b>üìÖ –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É</b>

–î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–∞—Ç—ã –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:"""
    
    await callback.message.edit_text(text, reply_markup=kb.get_calendar_menu(), parse_mode="HTML")
    await callback.answer("‚úèÔ∏è –ù–∞—á–∏–Ω–∞–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ")

# === –û–¢–ú–ï–ù–ê –ë–†–û–ù–ò ===
@router.callback_query(F.data == "book_cancel")
async def book_cancel(callback: CallbackQuery):
    """–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç–º–µ–Ω—ã –±—Ä–æ–Ω–∏"""
    user_id = callback.from_user.id
    
    active_booking = db.get_user_active_booking(user_id)
    if not active_booking:
        await callback.answer("‚ùå –ê–∫—Ç–∏–≤–Ω–∞—è –±—Ä–æ–Ω—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
        return
    
    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É
    booking_date = datetime.strptime(active_booking['date'], '%Y-%m-%d').strftime('%d.%m.%Y')
    
    text = f"""<b>‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ?</b>

–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ?

üìÖ <b>–î–∞—Ç–∞:</b> {booking_date}
üïê <b>–í—Ä–µ–º—è:</b> {active_booking['time']}:00
üë• <b>–ì–æ—Å—Ç–∏:</b> {active_booking['guests']} {get_guest_word(active_booking['guests'])}

–ü–æ—Å–ª–µ –æ—Ç–º–µ–Ω—ã –≤—ã —Å–º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –±—Ä–æ–Ω—å."""
    
    await callback.message.edit_text(text, reply_markup=kb.get_cancel_confirm_menu(), parse_mode="HTML")
    await callback.answer()

@router.callback_query(F.data == "cancel_confirm")
async def cancel_confirm(callback: CallbackQuery):
    """–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω–∞—è –æ—Ç–º–µ–Ω–∞ –±—Ä–æ–Ω–∏"""
    user_id = callback.from_user.id
    
    active_booking = db.get_user_active_booking(user_id)
    if active_booking:
        db.cancel_booking(active_booking['id'])
    
    text = """<b>‚ùå –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ</b>

–í–∞—à–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–º–µ–Ω–µ–Ω–æ.

–í—ã –º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –±—Ä–æ–Ω—å –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è."""
    
    await callback.message.edit_text(text, reply_markup=kb.get_back_button("menu_booking"), parse_mode="HTML")
    await callback.answer("–ë—Ä–æ–Ω—å –æ—Ç–º–µ–Ω–µ–Ω–∞")

@router.callback_query(F.data == "cancel_no")
async def cancel_no(callback: CallbackQuery):
    """–û—Ç–º–µ–Ω–∞ –æ—Ç–º–µ–Ω—ã (–≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é)"""
    user_id = callback.from_user.id
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω–∞—è –±—Ä–æ–Ω—å
    active_booking = db.get_user_active_booking(user_id)
    
    if active_booking:
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É
        booking_date = datetime.strptime(active_booking['date'], '%Y-%m-%d').strftime('%d.%m.%Y')
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω (—Å–∫—Ä—ã–≤–∞–µ–º —á–∞—Å—Ç—å —Ü–∏—Ñ—Ä)
        phone = active_booking['phone']
        if len(phone) >= 11:
            masked_phone = f"+7 XXX XXX {phone[-4:-2]} {phone[-2:]}"
        else:
            masked_phone = phone
        
        text = f"""<b>üìÖ –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–æ–ª–∏–∫–∞</b>

‚úÖ –£ –≤–∞—Å –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è –±—Ä–æ–Ω—å:

üìÖ <b>–î–∞—Ç–∞:</b> {booking_date}
üïê <b>–í—Ä–µ–º—è:</b> {active_booking['time']}:00
üìû <b>–¢–µ–ª–µ—Ñ–æ–Ω:</b> {masked_phone}
üë• <b>–ì–æ—Å—Ç–∏:</b> {active_booking['guests']} {get_guest_word(active_booking['guests'])}

–ß—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–¥–µ–ª–∞—Ç—å?"""
    else:
        text = f"""<b>üìÖ –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–æ–ª–∏–∫–∞</b>

–ó–∞–±—Ä–æ–Ω–∏—Ä—É–π—Ç–µ —Å—Ç–æ–ª–∏–∫ –æ–Ω–ª–∞–π–Ω –≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–ª–∏–∫–æ–≤!

–ü—Ä–æ—Ü–µ—Å—Å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:
1. üìÖ –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É
2. üïê –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è  
3. üë• –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ—Å—Ç–µ–π
4. üìû –í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω
5. ‚úÖ –ë—Ä–æ–Ω—å –≥–æ—Ç–æ–≤–∞!

–ò–ª–∏ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É: {RESTAURANT_PHONE}"""
    
    await callback.message.edit_text(
        text, 
        reply_markup=kb.get_booking_menu(has_active_booking=bool(active_booking)), 
        parse_mode="HTML"
    )
    await callback.answer()

# === –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ===
def get_guest_word(count):
    """–ü–æ–ª—É—á–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–ª–æ–≤–æ –¥–ª—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≥–æ—Å—Ç–µ–π"""
    if count == 1:
        return "–≥–æ—Å—Ç—å"
    elif 2 <= count <= 4:
        return "–≥–æ—Å—Ç—è"
    else:
        return "–≥–æ—Å—Ç–µ–π"

"""
handlers/main_handlers.py
–û—Å–Ω–æ–≤–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
"""

from aiogram import Router
from aiogram.types import Message
from aiogram.filters import CommandStart, Command
import keyboards as kb
from config import RESTAURANT_NAME, RESTAURANT_ADDRESS, RESTAURANT_PHONE, RESTAURANT_HOURS

router = Router()

@router.message(CommandStart())
async def cmd_start(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    text = f"""<b>{RESTAURANT_NAME}</b>

–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!

–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:

<b>üçΩÔ∏è –ú–µ–Ω—é</b> - –ø–æ–ª–Ω–æ–µ –º–µ–Ω—é, –¥–æ—Å—Ç–∞–≤–∫–∞, —Å–∞–º–æ–≤—ã–≤–æ–∑
<b>üìÖ –ë—Ä–æ–Ω—å —Å—Ç–æ–ª–∏–∫–∞</b> - –æ–Ω–ª–∞–π–Ω-–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
<b>üè¢ –ì–∞–ª–µ—Ä–µ—è</b> - 3D-—Ç—É—Ä –∏ —Ñ–æ—Ç–æ
<b>‚≠ê –û—Ç–∑—ã–≤—ã</b> - —Ä–µ–π—Ç–∏–Ω–≥ –∏ –æ—Ç–∑—ã–≤—ã
<b>üí¨ –û–ø–µ—Ä–∞—Ç–æ—Ä</b> - —Å–≤—è–∑—å —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
<b>üì∞ –ù–æ–≤–æ—Å—Ç–∏</b> - –∞–∫—Ü–∏–∏ –∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è

<b>–ö–æ–Ω—Ç–∞–∫—Ç—ã:</b>
üìç {RESTAURANT_ADDRESS}
üìû {RESTAURANT_PHONE}
üïê {RESTAURANT_HOURS}
"""
    
    await message.answer(text, reply_markup=kb.get_main_menu(), parse_mode="HTML")

@router.message(Command("help"))
async def cmd_help(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help"""
    text = """<b>–ü–æ–º–æ—â—å –ø–æ –±–æ—Ç—É</b>

–≠—Ç–æ—Ç –±–æ—Ç –ø–æ–º–æ–∂–µ—Ç –≤–∞–º:
‚Ä¢ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –º–µ–Ω—é –∏ —Å–¥–µ–ª–∞—Ç—å –∑–∞–∫–∞–∑
‚Ä¢ –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–æ–ª–∏–∫
‚Ä¢ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ñ–æ—Ç–æ –∏ 3D-—Ç—É—Ä —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
‚Ä¢ –ß–∏—Ç–∞—Ç—å –æ—Ç–∑—ã–≤—ã –Ω–∞ –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç–∞—Ö
‚Ä¢ –°–≤—è–∑–∞—Ç—å—Å—è —Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º
‚Ä¢ –£–∑–Ω–∞—Ç—å –Ω–æ–≤–æ—Å—Ç–∏

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏."""
    
    await message.answer(text, parse_mode="HTML")

"""
keyboards/main_menus.py
–ì–ª–∞–≤–Ω—ã–µ –º–µ–Ω—é –±–æ—Ç–∞
"""

from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from config import YANDEX_REVIEWS_URL, YANDEX_ADD_REVIEW_URL, THREE_D_TOUR_URL

def get_main_menu():
    """–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –±–æ—Ç–∞"""
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [
                InlineKeyboardButton(text="üçΩÔ∏è –ú–µ–Ω—é", callback_data="menu_food"),
                InlineKeyboardButton(text="üìÖ –ë—Ä–æ–Ω—å", callback_data="menu_booking")
            ],
            [
                InlineKeyboardButton(text="üè¢ –ì–∞–ª–µ—Ä–µ—è", callback_data="menu_gallery"),
                InlineKeyboardButton(text="‚≠ê –û—Ç–∑—ã–≤—ã", callback_data="menu_reviews")
            ],
            [
                InlineKeyboardButton(text="üí¨ –û–ø–µ—Ä–∞—Ç–æ—Ä", callback_data="menu_operator"),
                InlineKeyboardButton(text="üì∞ –ù–æ–≤–æ—Å—Ç–∏", callback_data="menu_news")
            ]
        ]
    )

def get_reviews_menu():
    """–ú–µ–Ω—é –æ—Ç–∑—ã–≤–æ–≤ - —Ç–æ–ª—å–∫–æ —Å—Å—ã–ª–∫–∏"""
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [
                InlineKeyboardButton(text="‚≠ê –ß–∏—Ç–∞—Ç—å –æ—Ç–∑—ã–≤—ã", url=YANDEX_REVIEWS_URL),
                InlineKeyboardButton(text="üìù –û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤", url=YANDEX_ADD_REVIEW_URL)
            ],
            [
                InlineKeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back_main")
            ]
        ]
    )

def get_gallery_menu():
    """–ú–µ–Ω—é –≥–∞–ª–µ—Ä–µ–∏"""
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [
                InlineKeyboardButton(text="üé¨ 3D-—Ç—É—Ä", url=THREE_D_TOUR_URL),
                InlineKeyboardButton(text="üì∏ –§–æ—Ç–æ", callback_data="gallery_photos")
            ],
            [
                InlineKeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back_main")
            ]
        ]
    )

"""
keyboards/sub_menus.py
–ü–æ–¥–º–µ–Ω—é –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ä–∞–∑–¥–µ–ª–æ–≤ —Å –∫–Ω–æ–ø–∫–∞–º–∏ –Ω–∞–∑–∞–¥
"""

from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton

def get_food_menu():
    """–ú–µ–Ω—é —Ä–∞–∑–¥–µ–ª–∞ –µ–¥—ã"""
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [
                InlineKeyboardButton(text="üìã –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –º–µ–Ω—é", callback_data="food_view"),
            ],
            [
                InlineKeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back_main")
            ]
        ]
    )

def get_booking_menu(has_active_booking=False):
    """–ú–µ–Ω—é –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è - —Ç–µ–ø–µ—Ä—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ"""
    if has_active_booking:
        # –ï—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è –±—Ä–æ–Ω—å - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        return InlineKeyboardMarkup(
            inline_keyboard=[
                [
                    InlineKeyboardButton(text="‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –±—Ä–æ–Ω—å", callback_data="book_edit"),
                    InlineKeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –±—Ä–æ–Ω—å", callback_data="book_cancel")
                ],
                [
                    InlineKeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back_main")
                ]
            ]
        )
    else:
        # –ï—Å–ª–∏ –Ω–µ—Ç –±—Ä–æ–Ω–∏ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–æ–∑–¥–∞–Ω–∏—è
        return InlineKeyboardMarkup(
            inline_keyboard=[
                [
                    InlineKeyboardButton(text="üìÖ –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–æ–ª–∏–∫", callback_data="book_date"),
                ],
                [
                    InlineKeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back_main")
                ]
            ]
        )

def get_booking_start_menu():
    """–ú–µ–Ω—é –Ω–∞—á–∞–ª–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (–≤—ã–±–æ—Ä –¥–∞—Ç—ã)"""
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [
                InlineKeyboardButton(text="üìÖ –í—ã–±—Ä–∞—Ç—å –¥–∞—Ç—É", callback_data="book_date_select"),
            ],
            [
                InlineKeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="menu_booking")
            ]
        ]
    )

def get_operator_menu():
    """–ú–µ–Ω—é –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞"""
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [
                InlineKeyboardButton(text="üïê –ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã", callback_data="op_hours"),
                InlineKeyboardButton(text="üìç –ê–¥—Ä–µ—Å", callback_data="op_address")
            ],
            [
                InlineKeyboardButton(text="üöö –î–æ—Å—Ç–∞–≤–∫–∞", callback_data="op_delivery"),
                InlineKeyboardButton(text="üìû –ü–æ–∑–≤–∞—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞", callback_data="op_call")
            ],
            [
                InlineKeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back_main")
            ]
        ]
    )

def get_menu_categories():
    """–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –º–µ–Ω—é"""
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [
                InlineKeyboardButton(text="ü•ó –°–∞–ª–∞—Ç—ã", callback_data="cat_salads"),
                InlineKeyboardButton(text="üç≤ –°—É–ø—ã", callback_data="cat_soups")
            ],
            [
                InlineKeyboardButton(text="üçñ –ì–æ—Ä—è—á–µ–µ", callback_data="cat_hot"),
                InlineKeyboardButton(text="üç∞ –î–µ—Å–µ—Ä—Ç—ã", callback_data="cat_desserts")
            ],
            [
                InlineKeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="menu_food")
            ]
        ]
    )

def get_guests_menu():
    """–í—ã–±–æ—Ä –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≥–æ—Å—Ç–µ–π (–æ—Ç 1 –¥–æ 6)"""
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [
                InlineKeyboardButton(text="üë§ 1", callback_data="guests_1"),
                InlineKeyboardButton(text="üë• 2", callback_data="guests_2"),
                InlineKeyboardButton(text="üë• 3", callback_data="guests_3")
            ],
            [
                InlineKeyboardButton(text="üë• 4", callback_data="guests_4"),
                InlineKeyboardButton(text="üë• 5", callback_data="guests_5"),
                InlineKeyboardButton(text="üë• 6", callback_data="guests_6")
            ],
            [
                InlineKeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="select_time_back")
            ]
        ]
    )

def get_booking_confirmation_menu():
    """–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è"""
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [
                InlineKeyboardButton(text="‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ", callback_data="booking_final_confirm"),
            ],
            [
                InlineKeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="select_guests_back")
            ]
        ]
    )

def get_cancel_confirm_menu():
    """–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç–º–µ–Ω—ã –±—Ä–æ–Ω–∏"""
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [
                InlineKeyboardButton(text="‚úÖ –î–∞, –æ—Ç–º–µ–Ω–∏—Ç—å", callback_data="cancel_confirm"),
                InlineKeyboardButton(text="‚ùå –ù–µ—Ç, –æ—Å—Ç–∞–≤–∏—Ç—å", callback_data="cancel_no")
            ]
        ]
    )

def get_back_button(to_menu):
    """–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥"""
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data=to_menu)]
        ]
    )

def get_order_done_menu():
    """–ö–Ω–æ–ø–∫–∞ "–ì–æ—Ç–æ–≤–æ" –ø–æ—Å–ª–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞"""
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(text="‚úÖ –ì–æ—Ç–æ–≤–æ", callback_data="order_done")]
        ]
    )

def get_news_menu():
    """–ú–µ–Ω—é –Ω–æ–≤–æ—Å—Ç–µ–π"""
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [
                InlineKeyboardButton(text="üì¢ –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è", url="https://t.me/Mashkov_rest"),
            ],
            [
                InlineKeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back_main")
            ]
        ]
    )

"""
services/yandex_reviews.py
–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Å—ã–ª–∫–∞–º–∏ –Ω–∞ –æ—Ç–∑—ã–≤—ã
"""

# –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
RATING_INFO = {
    "rating": "5/5",
    "reviews_count": "634 –æ—Ü–µ–Ω–∫–∏",
    "last_checked": "–Ø–Ω–≤–∞—Ä—å 2026",
    "yandex_url": "https://yandex.ru/maps/org/mashkov/202266309008/reviews/"
}

async def get_rating_info():
    """–ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–µ–π—Ç–∏–Ω–≥–µ"""
    return RATING_INFO


"""
handlers/__init__.py
–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
"""

from .main_handlers import router as main_router
from .callback_handlers import router as callback_router
from .booking_handlers import router as booking_router

__all__ = [
    'main_router',
    'callback_router',
    'booking_router'
]


"""
keyboards/__init__.py
–≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö –∫–ª–∞–≤–∏–∞—Ç—É—Ä
"""

from .main_menus import (
    get_main_menu,
    get_reviews_menu,
    get_gallery_menu
)
from .sub_menus import (
    get_food_menu,
    get_booking_menu,
    get_booking_start_menu,
    get_booking_confirmation_menu,
    get_cancel_confirm_menu,
    get_operator_menu,
    get_menu_categories,
    get_guests_menu,
    get_back_button,
    get_order_done_menu,
    get_news_menu
)
from .calendar import (
    get_calendar_menu,
    get_time_menu
)
from .cart import (
    get_cart_menu,
    get_checkout_menu,
    get_back_to_cart
)

__all__ = [
    'get_main_menu',
    'get_reviews_menu',
    'get_gallery_menu',
    'get_food_menu',
    'get_booking_menu',
    'get_booking_start_menu',
    'get_booking_confirmation_menu',
    'get_cancel_confirm_menu',
    'get_operator_menu',
    'get_menu_categories',
    'get_guests_menu',
    'get_back_button',
    'get_order_done_menu',
    'get_news_menu',
    'get_calendar_menu',
    'get_time_menu',
    'get_cart_menu',
    'get_checkout_menu',
    'get_back_to_cart'
]


"""
services/__init__.py
–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤
"""