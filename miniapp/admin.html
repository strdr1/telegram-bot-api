<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å Mashkov</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            height: 100vh;
            overflow: hidden;
            -webkit-text-size-adjust: 100%;
        }

        .container {
            display: flex;
            height: 100vh;
            flex-direction: row;
            overflow: hidden;
        }

        /* –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å - —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ */
        .sidebar {
            width: 100%;
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
            transition: transform 0.3s ease;
        }

        .sidebar.hidden {
            transform: translateX(-100%);
        }

        /* –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å - —á–∞—Ç */
        .main-content {
            width: 100%;
            display: flex;
            flex-direction: column;
            background: var(--tg-theme-bg-color, #ffffff);
            height: 100vh;
            overflow: hidden;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 20;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .main-content.active {
            transform: translateX(0);
        }

        /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π */
        .header {
            padding: 12px 15px;
            background: var(--tg-theme-button-color, #0088cc);
            color: var(--tg-theme-button-text-color, white);
            flex-shrink: 0;
            text-align: center;
        }

        .header h1 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            gap: 8px;
        }

        .stat {
            text-align: center;
            flex: 1;
        }

        .stat-number {
            font-size: 18px;
            font-weight: bold;
            display: block;
        }

        .stat-label {
            font-size: 10px;
            opacity: 0.9;
            margin-top: 2px;
        }

        /* –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ */
        .chat-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            -webkit-overflow-scrolling: touch;
        }

        .chat-item {
            background: var(--tg-theme-bg-color, #ffffff);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .chat-item:hover {
            background: var(--tg-theme-hint-color, #f0f0f0);
        }

        .chat-item.active {
            border-color: var(--tg-theme-button-color, #0088cc);
            background: var(--tg-theme-button-color, #0088cc);
            color: var(--tg-theme-button-text-color, white);
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .chat-user {
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 70%;
        }

        .chat-status {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 500;
            flex-shrink: 0;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-paused {
            background: #fff3cd;
            color: #856404;
        }

        .status-help_needed {
            background: #f8d7da;
            color: #721c24;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .chat-item.active .status-active,
        .chat-item.active .status-paused {
            background: rgba(255,255,255,0.2);
            color: var(--tg-theme-button-text-color, white);
        }

        .chat-preview {
            font-size: 12px;
            opacity: 0.8;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-bottom: 4px;
        }

        .chat-meta {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            opacity: 0.7;
        }

        /* –û–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .chat-header-main {
            padding: 12px 15px;
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-bottom: 1px solid var(--tg-theme-hint-color, #e0e0e0);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            position: relative;
        }

        .chat-title {
            font-size: 16px;
            font-weight: 600;
            margin-left: 10px;
        }

        .back-btn {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--tg-theme-text-color, #000);
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .back-btn:hover {
            background: rgba(0,0,0,0.1);
        }

        /* –°–æ–æ–±—â–µ–Ω–∏—è */
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px 15px 5px 15px;
            background: var(--tg-theme-bg-color, #ffffff);
            -webkit-overflow-scrolling: touch;
            display: flex;
            flex-direction: column;
        }

        .message {
            margin-bottom: 10px;
            max-width: 85%;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            align-self: flex-end;
        }

        .message.bot {
            align-self: flex-start;
        }

        .message-bubble {
            padding: 10px 14px;
            border-radius: 18px;
            font-size: 15px;
            line-height: 1.4;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .message.user .message-bubble {
            background: var(--tg-theme-button-color, #0088cc);
            color: var(--tg-theme-button-text-color, white);
            border-bottom-right-radius: 4px;
        }

        .message.bot .message-bubble {
            background: var(--tg-theme-secondary-bg-color, #f1f1f1);
            color: var(--tg-theme-text-color, #000000);
            border-bottom-left-radius: 4px;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.6;
            margin-top: 4px;
            text-align: right;
            padding: 0 5px;
        }

        .message.bot .message-time {
            text-align: left;
        }

        /* –í–≤–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏—è */
        .message-input {
            padding: 10px 15px;
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-top: 1px solid var(--tg-theme-hint-color, #e0e0e0);
            display: flex;
            gap: 10px;
            align-items: center;
            flex-shrink: 0;
            position: relative;
        }

        .message-input input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--tg-theme-hint-color, #ddd);
            border-radius: 24px;
            font-size: 15px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            outline: none;
        }

        .message-input input:focus {
            border-color: var(--tg-theme-button-color, #0088cc);
        }

        /* –ù–ê–°–¢–û–Ø–©–ò–ï –ö–ù–û–ü–ö–ò */
        .btn {
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 14px 16px;
            text-align: center;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
            position: relative;
            overflow: hidden;
            outline: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .btn:active {
            transform: translateY(2px);
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }

        .btn:focus:not(:active)::after {
            animation: ripple 1s ease-out;
        }

        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }
            100% {
                transform: scale(40, 40);
                opacity: 0;
            }
        }

        .btn-primary {
            background: var(--tg-theme-button-color, #0088cc);
            color: var(--tg-theme-button-text-color, white);
        }

        .btn-primary:hover {
            background: #0077b3;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        .btn-light {
            background: #f8f9fa;
            color: #212529;
            border: 1px solid #dee2e6;
        }

        .btn-light:hover {
            background: #e2e6ea;
        }

        .btn-sm {
            padding: 8px 12px;
            font-size: 13px;
            border-radius: 10px;
        }

        .btn-lg {
            padding: 18px 24px;
            font-size: 17px;
            border-radius: 14px;
        }

        .btn-icon {
            padding: 12px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
        }

        .btn-icon .icon {
            font-size: 24px;
        }

        .btn-full {
            width: 100%;
        }

        .send-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            background: var(--tg-theme-button-color, #0088cc);
            color: var(--tg-theme-button-text-color, white);
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .send-btn:active {
            transform: scale(0.95);
        }

        .actions-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            background: var(--tg-theme-secondary-bg-color, #e9ecef);
            color: var(--tg-theme-text-color, #000);
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        .actions-btn:active {
            transform: scale(0.95);
        }

        /* –ú–ï–ù–Æ –î–ï–ô–°–¢–í–ò–ô */
        .actions-menu {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--tg-theme-bg-color, #ffffff);
            border-radius: 20px 20px 0 0;
            padding: 20px 15px;
            box-shadow: 0 -5px 25px rgba(0,0,0,0.2);
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.165, 0.84, 0.44, 1);
            z-index: 1000;
            max-height: 80vh;
            overflow-y: auto;
        }

        .actions-menu.active {
            transform: translateY(0);
        }

        .actions-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--tg-theme-hint-color, #e0e0e0);
        }

        .action-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .action-grid .btn {
            flex-direction: column;
            height: 100px;
            padding: 16px 12px;
        }

        .action-grid .icon {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .action-grid .text {
            font-size: 13px;
            font-weight: 500;
            line-height: 1.2;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--tg-theme-hint-color, #e0e0e0);
        }

        .status-grid .btn {
            flex-direction: column;
            height: 80px;
            padding: 12px 8px;
        }

        /* –ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π */
        .history-panel {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--tg-theme-bg-color, #ffffff);
            z-index: 1100;
            display: none;
            flex-direction: column;
            animation: slideInRight 0.3s ease;
        }

        .history-panel.active {
            display: flex;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        .history-header {
            padding: 15px;
            border-bottom: 1px solid var(--tg-theme-hint-color, #e0e0e0);
            display: flex;
            align-items: center;
            gap: 15px;
            font-weight: 600;
            font-size: 17px;
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            flex-shrink: 0;
        }

        /* Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .overlay.active {
            display: block;
            opacity: 1;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            display: none;
        }

        .modal-content {
            background: var(--tg-theme-bg-color, #fff);
            padding: 20px;
            border-radius: 16px;
            width: 90%;
            max-width: 320px;
            margin: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è */
        @media (max-width: 768px) {
            .header {
                padding: 10px;
            }

            .header h1 {
                font-size: 15px;
            }

            .stat-number {
                font-size: 16px;
            }

            .chat-item {
                padding: 10px;
                margin-bottom: 6px;
            }

            .chat-user {
                font-size: 13px;
            }

            .chat-preview {
                font-size: 11px;
            }

            .message-bubble {
                padding: 8px 12px;
                font-size: 14px;
            }

            .message-input {
                padding: 10px;
            }

            .message-input input {
                padding: 10px 14px;
                font-size: 14px;
            }

            .send-btn, .actions-btn {
                width: 44px;
                height: 44px;
            }

            .action-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .action-grid .btn {
                height: 90px;
                padding: 14px 10px;
            }

            .action-grid .icon {
                font-size: 24px;
            }

            .status-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .status-grid .btn {
                height: 70px;
                padding: 10px 6px;
                font-size: 13px;
            }
        }

        @media (max-width: 480px) {
            .action-grid {
                grid-template-columns: 1fr;
            }

            .action-grid .btn {
                flex-direction: row;
                height: 60px;
                justify-content: flex-start;
                padding: 14px 16px;
                text-align: left;
            }

            .action-grid .icon {
                margin-bottom: 0;
                margin-right: 12px;
                font-size: 22px;
            }

            .status-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .status-grid .btn {
                flex-direction: row;
                height: 50px;
                justify-content: flex-start;
                padding: 12px 16px;
            }
        }

        /* Utility */
        .hidden {
            display: none !important;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--tg-theme-hint-color, #999);
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--tg-theme-hint-color, #ddd);
            border-radius: 50%;
            border-top-color: var(--tg-theme-button-color, #0088cc);
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å - —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ -->
        <div class="sidebar" id="sidebar">
            <div class="header">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h1>üé≠ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å Mashkov</h1>
                    <button onclick="openSettings()" style="background:none; border:none; color:white; font-size:18px; cursor:pointer;">‚öôÔ∏è</button>
                </div>
                <div class="stats">
                    <div class="stat">
                        <span class="stat-number" id="total-chats">0</span>
                        <div class="stat-label">–í—Å–µ–≥–æ —á–∞—Ç–æ–≤</div>
                    </div>
                    <div class="stat">
                        <span class="stat-number" id="active-chats">0</span>
                        <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
                    </div>
                    <div class="stat">
                        <span class="stat-number" id="paused-chats">0</span>
                        <div class="stat-label">–ù–∞ –ø–∞—É–∑–µ</div>
                    </div>
                    <div class="stat">
                        <span class="stat-number" id="help-needed-chats" style="color: #dc3545;">0</span>
                        <div class="stat-label" style="color: #dc3545;">–ü–æ–º–æ—â—å</div>
                    </div>
                </div>
            </div>
            
            <div class="chat-list" id="chat-list">
                <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤...</div>
            </div>
        </div>

        <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å - —á–∞—Ç -->
        <div class="main-content" id="main-content">
            <div class="chat-area" id="chat-area">
                <div class="empty-state">
                    <h3>üí¨ –í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h3>
                    <p>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–ª–µ–≤–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏–π</p>
                </div>
            </div>
        </div>

        <!-- –ü–∞–Ω–µ–ª—å –∏—Å—Ç–æ—Ä–∏–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
        <div class="history-panel" id="history-panel">
            <div class="history-header">
                <button class="back-btn" onclick="toggleHistory()">‚Üê</button>
                –ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π
            </div>
            <div class="messages" id="history-list">
                <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>
    </div>

    <!-- Overlay -->
    <div class="overlay" id="overlay" onclick="closeActionsMenu()"></div>

    <!-- –ú–µ–Ω—é –¥–µ–π—Å—Ç–≤–∏–π -->
    <div class="actions-menu" id="actions-menu">
        <div class="actions-header">–î–µ–π—Å—Ç–≤–∏—è</div>
        
        <div class="action-grid">
            <button class="btn btn-primary" onclick="handleAction('send_photo')">
                <span class="icon">üñºÔ∏è</span>
                <span class="text">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ</span>
            </button>
            
            <button class="btn btn-info" onclick="handleAction('send_file')">
                <span class="icon">üìÑ</span>
                <span class="text">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª</span>
            </button>
            
            <button class="btn btn-success" onclick="handleAction('send_menu')">
                <span class="icon">üìã</span>
                <span class="text">–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –º–µ–Ω—é</span>
            </button>
            
            <button class="btn btn-light" onclick="handleAction('history')">
                <span class="icon">üïí</span>
                <span class="text">–ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π</span>
            </button>
        </div>

        <div class="status-grid">
            <button class="btn btn-success" onclick="updateStatus('active')">
                <span class="icon">‚ñ∂Ô∏è</span>
                <span>–í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å</span>
            </button>
            
            <button class="btn btn-warning" onclick="updateStatus('paused')">
                <span class="icon">‚è∏Ô∏è</span>
                <span>–ü–∞—É–∑–∞</span>
            </button>
            
            <button class="btn btn-danger" onclick="updateStatus('help_needed')">
                <span class="icon">‚ùó</span>
                <span>–ü–æ–º–æ—â—å</span>
            </button>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal" id="settings-modal">
        <div class="modal-content">
            <h3 style="margin-bottom:15px;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:5px; font-size:12px; opacity:0.7;">–ü–æ—Ä–æ–≥ –∏–∑–º–µ–Ω–µ–Ω–∏–π –º–µ–Ω—é (%)</label>
                <input type="number" id="menu-threshold-input" value="15" style="width:100%; padding:8px; border:1px solid var(--tg-theme-hint-color, #ddd); border-radius:6px;">
            </div>
            <div style="display:flex; justify-content:flex-end; gap:10px;">
                <button class="btn btn-secondary" onclick="closeSettings()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-primary" onclick="saveSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- File input -->
    <input type="file" id="file-input" class="hidden" accept="image/*,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document">
</body>

<script>
    const API_BASE = 'https://a950841.fvds.ru/api';
    let chats = [];
    let currentChatId = null;
    let currentMessages = [];
    let previousHelpNeededIds = new Set();
    let audioCtx = null;
    let audioEnabled = false;

    // Initialize audio
    function initAudio() {
        if (audioCtx) return;
        try {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            audioCtx.resume().then(() => {
                audioEnabled = true;
            }).catch((e) => {
                console.error('Audio resume failed:', e);
            });
        } catch (e) {
            console.error('Audio init failed:', e);
        }
    }

    // Sound notification
    function playBeep() {
        if (!audioCtx || !audioEnabled) return;
        try {
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            oscillator.type = 'sine';
            oscillator.frequency.value = 800;
            gainNode.gain.value = 0.1;

            oscillator.start();
            setTimeout(() => oscillator.stop(), 200);
        } catch (e) {
            console.error('Audio play failed:', e);
        }
    }

    // Telegram WebApp
    const tg = window.Telegram?.WebApp;
    
    if (tg) {
        tg.ready();
        tg.expand();
        
        // Set theme colors
        document.documentElement.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color || '#ffffff');
        document.documentElement.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color || '#000000');
        document.documentElement.style.setProperty('--tg-theme-hint-color', tg.themeParams.hint_color || '#999999');
        document.documentElement.style.setProperty('--tg-theme-button-color', tg.themeParams.button_color || '#0088cc');
        document.documentElement.style.setProperty('--tg-theme-button-text-color', tg.themeParams.button_text_color || '#ffffff');
        document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', tg.themeParams.secondary_bg_color || '#f1f1f1');
    }

    // Load chats
    async function loadChats() {
        try {
            const response = await fetch(`${API_BASE}/chats?t=${Date.now()}`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            chats = await response.json();
            
            // Check for new help needed chats
            const currentHelpNeededIds = new Set(chats.filter(c => c.chat_status === 'help_needed').map(c => c.id));
            const hasNew = [...currentHelpNeededIds].some(id => !previousHelpNeededIds.has(id));
            
            if (hasNew) {
                playBeep();
                if (tg) tg.HapticFeedback.notificationOccurred('error');
            }
            
            previousHelpNeededIds = currentHelpNeededIds;
            
            displayChats();
            displayStats();
            
        } catch (error) {
            console.error('Error loading chats:', error);
            document.getElementById('chat-list').innerHTML = 
                `<div class="loading">‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏<br>
                 <button class="btn btn-primary" onclick="loadChats()" style="margin-top: 10px; width: 100%;">üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button></div>`;
            
            displayStats({ total_chats: 0, active_chats: 0, paused_chats: 0 });
        }
    }

    // Display chats
    function displayChats() {
        const chatList = document.getElementById('chat-list');
        
        if (!chats || chats.length === 0) {
            chatList.innerHTML = '<div class="loading">–ù–µ—Ç —á–∞—Ç–æ–≤</div>';
            return;
        }

        chatList.innerHTML = chats.map(chat => `
            <div class="chat-item" onclick="selectChat(${chat.id})" data-chat-id="${chat.id}">
                <div class="chat-header">
                    <div class="chat-user">üë§ ${chat.user_name || `ID: ${chat.user_id}`}</div>
                    <div class="chat-status ${
                        chat.chat_status === 'active' ? 'status-active' : 
                        chat.chat_status === 'help_needed' ? 'status-help_needed' : 'status-paused'
                    }">
                        ${
                            chat.chat_status === 'active' ? '–ê–∫—Ç–∏–≤–µ–Ω' : 
                            chat.chat_status === 'help_needed' ? '‚ùó –ü–æ–º–æ—â—å' : '–ü–∞—É–∑–∞'
                        }
                    </div>
                </div>
                <div class="chat-preview">${chat.last_message || '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π'}</div>
                <div class="chat-meta">
                    <span>üí¨ ${chat.message_count || 0}</span>
                    <span>üïê ${formatTime(chat.last_message_time)}</span>
                </div>
            </div>
        `).join('');
    }

    // Display stats
    function displayStats(stats = null) {
        if (!stats) {
            stats = {
                total_chats: chats.length,
                active_chats: chats.filter(c => c.chat_status === 'active').length,
                paused_chats: chats.filter(c => c.chat_status === 'paused').length,
                help_needed_chats: chats.filter(c => c.chat_status === 'help_needed').length
            };
        }
        
        document.getElementById('total-chats').textContent = stats.total_chats;
        document.getElementById('active-chats').textContent = stats.active_chats;
        document.getElementById('paused-chats').textContent = stats.paused_chats;
        
        const helpNeededEl = document.getElementById('help-needed-chats');
        if (helpNeededEl) {
            helpNeededEl.textContent = stats.help_needed_chats || 0;
        }
    }

    // Select chat
    async function selectChat(chatId) {
        document.getElementById('sidebar').classList.add('hidden');
        document.getElementById('main-content').classList.add('active');
        
        document.querySelectorAll('.chat-item').forEach(item => {
            item.classList.remove('active');
        });
        
        const selectedItem = document.querySelector(`[data-chat-id="${chatId}"]`);
        if (selectedItem) selectedItem.classList.add('active');
        
        currentChatId = chatId;
        const chat = chats.find(c => c.id === chatId);
        
        await loadMessages(chatId);
        if (chat) displayChatArea(chat);
    }

    // Back to chats
    function backToChats() {
        currentChatId = null;
        
        document.getElementById('sidebar').classList.remove('hidden');
        document.getElementById('main-content').classList.remove('active');
        
        document.querySelectorAll('.chat-item').forEach(item => item.classList.remove('active'));
        
        loadChats();
    }

    // Display chat area
    function displayChatArea(chat) {
        const chatArea = document.getElementById('chat-area');
        
        chatArea.innerHTML = `
            <div class="chat-header-main">
                <div style="display:flex; align-items:center;">
                    <button class="back-btn" onclick="backToChats()">‚Üê</button>
                    <div class="chat-title">üë§ ${chat.user_name || `ID: ${chat.user_id}`}</div>
                </div>
                <button class="actions-btn" onclick="openActionsMenu()">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="1"></circle>
                        <circle cx="12" cy="5" r="1"></circle>
                        <circle cx="12" cy="19" r="1"></circle>
                    </svg>
                </button>
            </div>
            <div class="messages" id="messages"></div>
            <div class="message-input">
                <input type="text" id="message-text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="handleKeyPress(event)">
                <button class="send-btn" onclick="sendMessage()">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path>
                    </svg>
                </button>
            </div>
        `;
        
        displayMessages();
        
        setTimeout(() => {
            const input = document.getElementById('message-text');
            if (input) input.focus();
        }, 300);
    }

    // Load messages
    async function loadMessages(chatId, isBackground = false) {
        try {
            const response = await fetch(`${API_BASE}/chats/${chatId}?t=${Date.now()}`);
            if (!response.ok) throw new Error('Failed to load messages');
            
            const newMessages = await response.json();
            
            if (isBackground && currentMessages.length > 0) {
                if (JSON.stringify(newMessages) === JSON.stringify(currentMessages)) {
                    return;
                }
            }
            
            currentMessages = newMessages;
            displayMessages(isBackground);
            
        } catch (error) {
            console.error('Error loading messages:', error);
            if (!isBackground) {
                currentMessages = [];
                displayMessages();
            }
        }
    }

    // Display messages
    function displayMessages(preserveScroll = false) {
        const messagesContainer = document.getElementById('messages');
        if (!messagesContainer) return;
        
        const wasAtBottom = messagesContainer.scrollHeight - messagesContainer.scrollTop <= messagesContainer.clientHeight + 100;

        if (!currentMessages || currentMessages.length === 0) {
            messagesContainer.innerHTML = '<div class="loading">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
            return;
        }

        const dialogueMessages = currentMessages.filter(msg => 
            !msg.sender || msg.sender === 'user' || msg.sender === 'admin'
        );

        messagesContainer.innerHTML = dialogueMessages.map(msg => `
            <div class="message ${msg.is_from_user ? 'user' : 'bot'}">
                <div class="message-bubble">${msg.message_text}</div>
                <div class="message-time">${formatTime(msg.created_at)}</div>
            </div>
        `).join('');
        
        if (!preserveScroll || wasAtBottom) {
            setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 100);
        }
    }

    // Send message
    async function sendMessage() {
        const input = document.getElementById('message-text');
        const message = input.value.trim();
        
        if (!message || !currentChatId) return;
        
        try {
            const response = await fetch(`${API_BASE}/chats/${currentChatId}/reply`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message })
            });
            
            if (!response.ok) throw new Error('Failed to send message');
            
            input.value = '';
            await loadMessages(currentChatId);
            await loadChats();
            
            if (tg) {
                tg.HapticFeedback.notificationOccurred('success');
            }
            
        } catch (error) {
            console.error('Error sending message:', error);
            if (tg) {
                tg.HapticFeedback.notificationOccurred('error');
            }
        }
    }

    // Handle key press
    function handleKeyPress(event) {
        if (event.key === 'Enter') {
            sendMessage();
        }
    }

    // Open actions menu
    function openActionsMenu() {
        document.getElementById('actions-menu').classList.add('active');
        document.getElementById('overlay').classList.add('active');
        document.body.style.overflow = 'hidden';
        
        // Add haptic feedback
        if (tg && tg.HapticFeedback) {
            tg.HapticFeedback.selectionChanged();
        }
    }

    // Close actions menu
    function closeActionsMenu() {
        document.getElementById('actions-menu').classList.remove('active');
        document.getElementById('overlay').classList.remove('active');
        document.body.style.overflow = '';
    }

    // Handle action
    async function handleAction(action) {
        closeActionsMenu();
        
        if (!currentChatId) return;
        
        switch(action) {
            case 'send_photo':
            case 'send_file':
                document.getElementById('file-input').click();
                break;
            case 'send_menu':
                await executeCustomCommand('/menu');
                break;
            case 'history':
                toggleHistory();
                break;
        }
    }

    // Update status
    async function updateStatus(status) {
        if (!currentChatId) return;
        
        try {
            const response = await fetch(`${API_BASE}/chats/${currentChatId}/status`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: status })
            });
            
            if (!response.ok) throw new Error('Failed to update status');
            
            await loadChats();
            
            if (tg) {
                tg.HapticFeedback.notificationOccurred('success');
            }
            
        } catch (error) {
            console.error('Error updating status:', error);
            if (tg) {
                tg.HapticFeedback.notificationOccurred('error');
            }
        }
    }

    // Execute command
    async function executeCustomCommand(command) {
        if (!currentChatId) return;
        
        try {
            const response = await fetch(`${API_BASE}/chats/${currentChatId}/command`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ command })
            });
            
            if (!response.ok) throw new Error('Failed to execute command');
            
            await loadMessages(currentChatId);
            
            if (tg) {
                tg.HapticFeedback.notificationOccurred('success');
            }
            
        } catch (error) {
            console.error('Error executing command:', error);
            if (tg) {
                tg.HapticFeedback.notificationOccurred('error');
            }
        }
    }

    // Toggle history
    function toggleHistory() {
        const panel = document.getElementById('history-panel');
        const mainContent = document.getElementById('main-content');
        
        if (panel.classList.contains('active')) {
            panel.classList.remove('active');
            mainContent.classList.add('active');
        } else {
            panel.classList.add('active');
            mainContent.classList.remove('active');
            displayHistory();
        }
    }

    // Display history
    async function displayHistory() {
        const container = document.getElementById('history-list');
        if (!currentChatId) return;

        container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
        
        try {
            const response = await fetch(`${API_BASE}/chats/${currentChatId}/actions?t=${Date.now()}`);
            if (!response.ok) throw new Error('Failed to load history');
            
            const historyMessages = await response.json();
            
            if (!historyMessages || historyMessages.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>–ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π –ø—É—Å—Ç–∞</p></div>';
                return;
            }
            
            container.innerHTML = historyMessages.map(msg => `
                <div class="message bot">
                    <div class="message-bubble" style="background: #f0f0f0; color: #666; font-size: 13px;">
                        <b>${getActionIcon(msg.action)} ${getActionText(msg.action)}</b><br>
                        ${msg.details || ''}
                    </div>
                    <div class="message-time">${formatTime(msg.created_at)}</div>
                </div>
            `).join('');
            
        } catch (error) {
            console.error('Error loading history:', error);
            container.innerHTML = '<div class="loading">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
        }
    }

    // Get action icon
    function getActionIcon(action) {
        if (action.includes('status')) return 'üîÑ';
        if (action.includes('photo')) return 'üñºÔ∏è';
        if (action.includes('file')) return 'üìÑ';
        if (action.includes('menu')) return 'üìã';
        return '‚ö°';
    }

    // Get action text
    function getActionText(action) {
        if (action.includes('status_active')) return '–ß–∞—Ç –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω';
        if (action.includes('status_paused')) return '–ß–∞—Ç –ø–æ—Å—Ç–∞–≤–ª–µ–Ω –Ω–∞ –ø–∞—É–∑—É';
        if (action.includes('status_help')) return '–ó–∞–ø—Ä–æ—à–µ–Ω–∞ –ø–æ–º–æ—â—å';
        if (action.includes('send_photo')) return '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Ñ–æ—Ç–æ';
        if (action.includes('send_file')) return '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω —Ñ–∞–π–ª';
        if (action.includes('send_menu')) return '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –º–µ–Ω—é';
        return action;
    }

    // Settings
    async function openSettings() {
        document.getElementById('settings-modal').style.display = 'flex';
        
        try {
            const response = await fetch(`${API_BASE}/settings/menu-threshold`);
            if (response.ok) {
                const data = await response.json();
                document.getElementById('menu-threshold-input').value = data.value;
            }
        } catch (e) {
            console.error(e);
        }
    }
    
    function closeSettings() {
        document.getElementById('settings-modal').style.display = 'none';
    }
    
    async function saveSettings() {
        const value = document.getElementById('menu-threshold-input').value;
        try {
            const response = await fetch(`${API_BASE}/settings/menu-threshold`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ value })
            });
            
            if (response.ok) {
                closeSettings();
                if (tg && tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
            } else {
                alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
            }
        } catch (e) {
            console.error(e);
            alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
        }
    }

    // Format time
    function formatTime(timeString) {
        if (!timeString) return '';
        
        try {
            const date = new Date(timeString);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
            if (diff < 3600000) return `${Math.floor(diff / 60000)} –º–∏–Ω –Ω–∞–∑–∞–¥`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)} —á –Ω–∞–∑–∞–¥`;
            
            return date.toLocaleDateString('ru-RU', {
                day: '2-digit',
                month: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        } catch (e) {
            return timeString;
        }
    }

    // File upload
    document.getElementById('file-input').addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (!file || !currentChatId) return;
        
        try {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('chat_id', currentChatId);
            
            const response = await fetch(`${API_BASE}/files/upload`, {
                method: 'POST',
                body: formData
            });
            
            if (!response.ok) throw new Error('Failed to upload file');
            
            await loadMessages(currentChatId);
            await loadChats();
            
            if (tg) {
                tg.HapticFeedback.notificationOccurred('success');
            }
            
        } catch (error) {
            console.error('Error uploading file:', error);
            if (tg) {
                tg.HapticFeedback.notificationOccurred('error');
            }
        }
        
        e.target.value = '';
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        document.addEventListener('click', initAudio, { once: true });
        document.addEventListener('touchstart', initAudio, { once: true });
        
        loadChats();
    });

    // Auto refresh
    setInterval(loadChats, 5000);
    setInterval(() => {
        if (currentChatId) {
            loadMessages(currentChatId, true);
        }
    }, 3000);

    console.log('Admin panel loaded');
</script>
</html>