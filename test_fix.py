#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
–¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π AI —Å–∏—Å—Ç–µ–º—ã
"""

import asyncio
import sys
import os

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from ai_assistant import get_ai_response

async def test_ai_markers():
    """–¢–µ—Å—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –º–∞—Ä–∫–µ—Ä–æ–≤ AI"""
    print("üîß –¢–µ—Å—Ç–∏—Ä—É–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è AI –º–∞—Ä–∫–µ—Ä–æ–≤...\n")
    
    test_cases = [
        # –¢–µ—Å—Ç 1: –ü—Ä—è–º—ã–µ –≤–æ–ø—Ä–æ—Å—ã –æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ö
        ("–£ –≤–∞—Å –µ—Å—Ç—å –ø–∏—Ü—Ü–∞?", "PARSE_CATEGORY:–ø–∏—Ü—Ü–∞"),
        ("–ö–∞–∫–∏–µ —Å—É–ø—ã –µ—Å—Ç—å?", "PARSE_CATEGORY:—Å—É–ø"),
        ("–ï—Å—Ç—å –ª–∏ –¥–µ—Å–µ—Ä—Ç—ã?", "PARSE_CATEGORY:–¥–µ—Å–µ—Ä—Ç"),
        ("–£ –≤–∞—Å –µ—Å—Ç—å –ø–∏–≤–æ?", "PARSE_CATEGORY:–ø–∏–≤–æ"),
        
        # –¢–µ—Å—Ç 2: –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –±–ª—é–¥–∞
        ("–ü–∏—Ü—Ü–∞ 4 —Å—ã—Ä–∞", "DISH_PHOTO:–ü–∏—Ü—Ü–∞ 4 —Å—ã—Ä–∞"),
        ("–ë–æ—Ä—â", "DISH_PHOTO:–ë–æ—Ä—â"),
        
        # –¢–µ—Å—Ç 3: –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –∫–æ—Ä–æ—Ç–∫–∏–µ –æ—Ç–≤–µ—Ç—ã (—Å–∏–º—É–ª—è—Ü–∏—è)
        ("—Ö–æ—á—É", "–∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç"),
    ]
    
    passed = 0
    failed = 0
    
    for message, expected_marker in test_cases:
        try:
            print(f"üîç –¢–µ—Å—Ç–∏—Ä—É–µ–º: '{message}'")
            result = await get_ai_response(message, 999999999)
            
            print(f"üìù –†–µ–∑—É–ª—å—Ç–∞—Ç: {result}")
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤
            if expected_marker.startswith("PARSE_CATEGORY:"):
                if result.get('type') == 'text' and expected_marker in result.get('text', ''):
                    print(f"‚úÖ AI –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –º–∞—Ä–∫–µ—Ä: {expected_marker}")
                    passed += 1
                elif result.get('type') == 'category':
                    print(f"‚úÖ AI –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–ª –∫–∞—Ç–µ–≥–æ—Ä–∏—é —á–µ—Ä–µ–∑ fallback")
                    passed += 1
                else:
                    print(f"‚ùå AI –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –º–∞—Ä–∫–µ—Ä. –û–∂–∏–¥–∞–ª—Å—è: {expected_marker}")
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ª–∏ —Ä—É—Å—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥
                    if '–ü–∞—Ä—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é' in result.get('text', '') or '–ü–ê–†–°_–ö–ê–¢–ï–ì–û–†–ò–Ø' in result.get('text', ''):
                        print(f"üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: AI –ø–µ—Ä–µ–≤–æ–¥–∏—Ç –º–∞—Ä–∫–µ—Ä—ã –Ω–∞ —Ä—É—Å—Å–∫–∏–π!")
                    failed += 1
                    
            elif expected_marker.startswith("DISH_PHOTO:"):
                if result.get('type') in ['photo_with_text', 'dish_photo']:
                    print(f"‚úÖ AI –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–ª –±–ª—é–¥–æ")
                    passed += 1
                else:
                    print(f"‚ùå AI –ù–ï –æ–±—Ä–∞–±–æ—Ç–∞–ª –±–ª—é–¥–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ")
                    failed += 1
                    
            elif expected_marker == "–∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç":
                if result.get('type') == 'text':
                    print(f"‚úÖ AI –¥–∞–ª –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç")
                    passed += 1
                else:
                    print(f"‚ö†Ô∏è AI –¥–∞–ª –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ç–∏–ø –æ—Ç–≤–µ—Ç–∞")
                    passed += 1  # –ù–µ —Å—á–∏—Ç–∞–µ–º –æ—à–∏–±–∫–æ–π
            
            print()
            
        except Exception as e:
            print(f"üí• –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ '{message}': {e}")
            failed += 1
            print()
    
    print(f"üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:")
    print(f"‚úÖ –£—Å–ø–µ—à–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤: {passed}")
    print(f"‚ùå –ù–µ—É–¥–∞—á–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤: {failed}")
    
    if failed == 0:
        print("üéâ –í—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!")
    else:
        print("‚ö†Ô∏è –ï—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã, —Ç—Ä–µ–±—É—é—â–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –≤–Ω–∏–º–∞–Ω–∏—è")
    
    return failed == 0

async def test_context_simulation():
    """–°–∏–º—É–ª—è—Ü–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞"""
    print("\nüé≠ –¢–µ—Å—Ç–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –¥–∏–∞–ª–æ–≥...\n")
    
    # –°–∏–º—É–ª–∏—Ä—É–µ–º –¥–∏–∞–ª–æ–≥: –≤–æ–ø—Ä–æ—Å –æ –ø–∏—Ü—Ü–µ -> –∫–æ—Ä–æ—Ç–∫–∏–π –æ—Ç–≤–µ—Ç
    print("üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: '–ö–∞–∫–∞—è –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å —É –ø–∏—Ü—Ü—ã?'")
    result1 = await get_ai_response("–ö–∞–∫–∞—è –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å —É –ø–∏—Ü—Ü—ã?", 999999999)
    print(f"ü§ñ AI: {result1.get('text', '–ù–µ—Ç —Ç–µ–∫—Å—Ç–∞')[:100]}...")
    
    print("\nüë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: '–•–æ—á—É'")
    result2 = await get_ai_response("–•–æ—á—É", 999999999)
    print(f"ü§ñ AI: {result2}")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ª–∏ AI –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã
    if 'PARSE_CATEGORY:–ø–∏—Ü—Ü–∞' in result2.get('text', ''):
        print("‚úÖ AI –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç PARSE_CATEGORY –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ!")
        return True
    elif result2.get('type') == 'category':
        print("‚úÖ AI –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–ª –∫–æ–Ω—Ç–µ–∫—Å—Ç —á–µ—Ä–µ–∑ fallback!")
        return True
    else:
        print("‚ùå AI –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ")
        return False

async def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"""
    print("üöÄ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π AI —Å–∏—Å—Ç–µ–º—ã...\n")
    
    success1 = await test_ai_markers()
    success2 = await test_context_simulation()
    
    print(f"\nüèÅ –ò—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:")
    if success1 and success2:
        print("üéâ –í—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç! AI —Å–∏—Å—Ç–µ–º–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞!")
    else:
        print("üí• –¢—Ä–µ–±—É—é—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è")

if __name__ == "__main__":
    asyncio.run(main())